<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>后端手册 | MapGIS Boot</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/mapgis-boot-docs/favicon.ico">
    <meta name="description" content="基于Spring Boot、Spring Cloud & Alibaba的前后端分离微服务极速后台开发框架">
    <meta name="keywords" content="mapgis,开源,免费,mapgis boot,MapGIS-Boot">
    
    <link rel="preload" href="/mapgis-boot-docs/assets/css/0.styles.1ee03f85.css" as="style"><link rel="preload" href="/mapgis-boot-docs/assets/js/app.b0e7f9db.js" as="script"><link rel="preload" href="/mapgis-boot-docs/assets/js/2.ac73687b.js" as="script"><link rel="preload" href="/mapgis-boot-docs/assets/js/9.52885868.js" as="script"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/10.4df172ac.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/11.14242ab8.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/12.b43688b1.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/13.f0b71d75.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/14.f2272700.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/15.acb833f2.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/16.5ef8daf8.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/3.7af3625a.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/4.eb9b5ec8.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/5.d810003a.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/6.9d290eb7.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/7.16c6aa10.js"><link rel="prefetch" href="/mapgis-boot-docs/assets/js/8.796e2370.js">
    <link rel="stylesheet" href="/mapgis-boot-docs/assets/css/0.styles.1ee03f85.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/mapgis-boot-docs/zh/" class="home-link router-link-active"><img src="/mapgis-boot-docs/logo.png" alt="MapGIS Boot" class="logo"> <span class="site-name can-hide">MapGIS Boot</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/mapgis-boot-docs/zh/guide/document/introduction.html" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mapgis-boot-docs/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/mapgis-boot-docs/zh/guide/document/backend.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/mapgis/mapgis-boot" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/mapgis-boot-docs/zh/guide/document/introduction.html" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/mapgis-boot-docs/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/mapgis-boot-docs/zh/guide/document/backend.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/mapgis/mapgis-boot" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>文档</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/mapgis-boot-docs/zh/guide/document/introduction.html" class="sidebar-link">项目介绍</a></li><li><a href="/mapgis-boot-docs/zh/guide/document/frontend.html" class="sidebar-link">前端手册</a></li><li><a href="/mapgis-boot-docs/zh/guide/document/backend.html" aria-current="page" class="active sidebar-link">后端手册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#基础功能" class="sidebar-link">基础功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#数据权限-datascope" class="sidebar-link">数据权限 DataScope</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#多数据源-master-slave" class="sidebar-link">多数据源 Master Slave</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#限流-ratelimiter" class="sidebar-link">限流 RateLimiter</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#防重复提交-repeatsubmit" class="sidebar-link">防重复提交 RepeatSubmit</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#日志-log" class="sidebar-link">日志 Log</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#excel-导出-excel、excels" class="sidebar-link">Excel 导出 Excel、Excels</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#权限控制-requirespermissions、requiresroles、requireslogin" class="sidebar-link">权限控制 RequiresPermissions、RequiresRoles、RequiresLogin</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#全局控制器前缀-managerrestcontroller、servicesrestcontroller" class="sidebar-link">全局控制器前缀 ManagerRestController、ServicesRestController</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#防止-xss-攻击" class="sidebar-link">防止 XSS 攻击</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#aop-支持自调用" class="sidebar-link">AOP 支持自调用</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#配置时区" class="sidebar-link">配置时区</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#只读模式" class="sidebar-link">只读模式</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#单体和微服务自由切换" class="sidebar-link">单体和微服务自由切换</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#多数据库支持" class="sidebar-link">多数据库支持</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#flyway-数据库版本管理" class="sidebar-link">flyway 数据库版本管理</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#缓存管理" class="sidebar-link">缓存管理</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#验证码开启和关闭" class="sidebar-link">验证码开启和关闭</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#多终端登录开启和关闭" class="sidebar-link">多终端登录开启和关闭</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#配置密码最大错误次数-锁定时间" class="sidebar-link">配置密码最大错误次数/锁定时间</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#代码生成" class="sidebar-link">代码生成</a></li></ul></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#高级功能" class="sidebar-link">高级功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#基于oauth2的第三方用户登录" class="sidebar-link">基于OAuth2的第三方用户登录</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#cas单点登录" class="sidebar-link">CAS单点登录</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#微应用路由管理" class="sidebar-link">微应用路由管理</a></li></ul></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#单体版核心功能" class="sidebar-link">单体版核心功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#安全配置" class="sidebar-link">安全配置</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#登录流程" class="sidebar-link">登录流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#登出流程" class="sidebar-link">登出流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#注册流程" class="sidebar-link">注册流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#服务访问流程" class="sidebar-link">服务访问流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#微服务版核心功能" class="sidebar-link">微服务版核心功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#nacos-持久化" class="sidebar-link">Nacos 持久化</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#认证" class="sidebar-link">认证</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#接口调用" class="sidebar-link">接口调用</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#异步执行" class="sidebar-link">异步执行</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#网关" class="sidebar-link">网关</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#登录流程-2" class="sidebar-link">登录流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#登出流程-2" class="sidebar-link">登出流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#注册流程-2" class="sidebar-link">注册流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#服务调用流程" class="sidebar-link">服务调用流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#网关访问流程" class="sidebar-link">网关访问流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#网关限流流程" class="sidebar-link">网关限流流程</a></li><li class="sidebar-sub-header"><a href="/mapgis-boot-docs/zh/guide/document/backend.html#网关路由管理" class="sidebar-link">网关路由管理</a></li></ul></li></ul></li><li><a href="/mapgis-boot-docs/zh/guide/document/packer.html" class="sidebar-link">项目打包</a></li><li><a href="/mapgis-boot-docs/zh/guide/document/deploy.html" class="sidebar-link">部署运行</a></li><li><a href="/mapgis-boot-docs/zh/guide/document/skill.html" class="sidebar-link">实战技巧</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其它</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="后端手册"><a href="#后端手册" class="header-anchor">#</a> 后端手册</h1> <h2 id="基础功能"><a href="#基础功能" class="header-anchor">#</a> 基础功能</h2> <h3 id="数据权限-datascope"><a href="#数据权限-datascope" class="header-anchor">#</a> 数据权限 DataScope</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@DataScope</span><span class="token punctuation">(</span>deptAlias <span class="token operator">=</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DataScope</span><span class="token punctuation">(</span>deptAlias <span class="token operator">=</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> userAlias <span class="token operator">=</span> <span class="token string">&quot;u&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>基于 AOP 实现</strong></p> <blockquote><p>核心思想：拿到当前用户角色的数据权限，拼接 sql 子串，放入注解所在方法的第一个参数对应的 BaseEntity 的 params 上，最后在 MyBatis 的 mapper.xml 中去使用</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>select<span class="token punctuation">&quot;</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>...Result<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">refid</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>select...Vo<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 数据范围过滤 --&gt;</span>
    ${params.dataScope}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(controllerDataScope)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> point<span class="token punctuation">,</span> <span class="token class-name">DataScope</span> controllerDataScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">SysUser</span> user <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> deptAlias <span class="token operator">=</span> controllerDataScope<span class="token punctuation">.</span><span class="token function">deptAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> userAlias <span class="token operator">=</span> controllerDataScope<span class="token punctuation">.</span><span class="token function">userAlias</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token class-name">StringBuilder</span> sqlString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SysRole</span> role <span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">String</span> dataScope <span class="token operator">=</span> role<span class="token punctuation">.</span><span class="token function">getDataScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>DATA_SCOPE_ALL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dataScope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           sqlString <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token keyword">break</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DATA_SCOPE_CUSTOM<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dataScope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           sqlString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
               <span class="token string">&quot; OR {}.dept_id IN ( SELECT dept_id FROM sys_role_dept WHERE role_id = {} ) &quot;</span><span class="token punctuation">,</span> deptAlias<span class="token punctuation">,</span>
               role<span class="token punctuation">.</span><span class="token function">getRoleId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DATA_SCOPE_DEPT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dataScope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           sqlString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot; OR {}.dept_id = {} &quot;</span><span class="token punctuation">,</span> deptAlias<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DATA_SCOPE_DEPT_AND_CHILD<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dataScope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           sqlString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>
               <span class="token string">&quot; OR {}.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = {} or ancestors like {} OR ancestors like {}} OR ancestors like {} )&quot;</span><span class="token punctuation">,</span>
               deptAlias<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>DATA_SCOPE_SELF<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>dataScope<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>userAlias<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               sqlString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot; OR {}.user_id = {} &quot;</span><span class="token punctuation">,</span> userAlias<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
               <span class="token comment">// 数据权限为仅本人且没有userAlias别名不查询任何数据</span>
               sqlString<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot; OR 1=0 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>sqlString<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token class-name">Object</span> params <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> params <span class="token keyword">instanceof</span> <span class="token class-name">BaseEntity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token class-name">BaseEntity</span> baseEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BaseEntity</span><span class="token punctuation">)</span> params<span class="token punctuation">;</span>
           baseEntity<span class="token punctuation">.</span><span class="token function">getParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>DATA_SCOPE<span class="token punctuation">,</span> <span class="token string">&quot; AND (&quot;</span> <span class="token operator">+</span> sqlString<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="多数据源-master-slave"><a href="#多数据源-master-slave" class="header-anchor">#</a> 多数据源 Master Slave</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Master</span>
<span class="token annotation punctuation">@Slave</span>
</code></pre></div><p>重定义注解，简化对@DS(&quot;master&quot;)和@DS(&quot;slave&quot;)的使用</p> <blockquote><p>基于<a href="https://baomidou.com/pages/a61e1b/#%E6%96%87%E6%A1%A3-documentation" target="_blank" rel="noopener noreferrer">dynamic-datasource-spring-boot-starter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来支持多数据源</p></blockquote> <h4 id="单体版"><a href="#单体版" class="header-anchor">#</a> 单体版</h4> <p>支持 mysql、sqlite 两个数据库，采用手动注入多数据源并动态添加数据源的方式来实现。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">dynamic</span><span class="token punctuation">:</span>
      <span class="token key atrule">primary</span><span class="token punctuation">:</span> master
      <span class="token key atrule">strict</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DynamicDataSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DynamicRoutingDataSource</span> dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DynamicRoutingDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setPrimary</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getPrimary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setStrict</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getStrict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setStrategy</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setP6spy</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getP6spy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataSource<span class="token punctuation">.</span><span class="token function">setSeata</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getSeata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 动态添加数据源</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>dbType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token string">&quot;mysql&quot;</span><span class="token operator">:</span>
                <span class="token function">addMySQLDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">addSQLiteDataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            org<span class="token punctuation">.</span>flywaydb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>api<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span><span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token class-name">Flyway</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baselineDescription</span><span class="token punctuation">(</span><span class="token string">&quot;initByServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baselineOnMigrate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateOnMigrate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">locations</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:data/migration/%s&quot;</span><span class="token punctuation">,</span> dbType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Flyway</span> flyway <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flyway</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flyway<span class="token punctuation">.</span><span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;数据库迁移出现异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> dataSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="微服务版"><a href="#微服务版" class="header-anchor">#</a> 微服务版</h4> <p>支持主从数据库的配置，默认只配置了 master 数据源为 mysql。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">dynamic</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token comment"># 主库数据源</span>
        <span class="token key atrule">master</span><span class="token punctuation">:</span>
          <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
          <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mapgis<span class="token punctuation">-</span>xxx<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span>3306/mapgis<span class="token punctuation">-</span>cloud<span class="token punctuation">-</span>xxx<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span>
          <span class="token key atrule">username</span><span class="token punctuation">:</span> root
          <span class="token key atrule">password</span><span class="token punctuation">:</span> cloud123.mapgis
        <span class="token comment"># 从库数据源</span>
        <span class="token comment"># slave:</span>
        <span class="token comment"># username:</span>
        <span class="token comment"># password:</span>
        <span class="token comment"># url:</span>
        <span class="token comment"># driver-class-name:</span>
</code></pre></div><h3 id="限流-ratelimiter"><a href="#限流-ratelimiter" class="header-anchor">#</a> 限流 RateLimiter</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RateLimiter</span><span class="token punctuation">(</span>count <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> time <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>核心思想：通过 Redis 实现，在 RedisConfig 中自定义限流脚本，统计以方法调用为 key 的缓存有效期内的执行次数，是否大于限制，大于则抛出异常</p></blockquote> <p>因在单体版本中未使用 Redis（采用 Ehcache），所以该注解要使用必须引入对 Redis 的依赖，在微服务版中可直接使用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(rateLimiter)&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doBefore</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> point<span class="token punctuation">,</span> <span class="token class-name">RateLimiter</span> rateLimiter<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
  <span class="token class-name">String</span> key <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> time <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> count <span class="token operator">=</span> rateLimiter<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">String</span> combineKey <span class="token operator">=</span> <span class="token function">getCombineKey</span><span class="token punctuation">(</span>rateLimiter<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>combineKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token class-name">Long</span> number <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>limitScript<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> count<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span> <span class="token operator">||</span> number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;访问过于频繁，请稍候再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;限制请求'{}',当前请求'{}',缓存key'{}'&quot;</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> number<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ServiceException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;服务器限流异常，请稍候再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="防重复提交-repeatsubmit"><a href="#防重复提交-repeatsubmit" class="header-anchor">#</a> 防重复提交 RepeatSubmit</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RepeatSubmit</span>
</code></pre></div><blockquote><p>核心思路：基于过滤器和拦截器实现，在过滤器的 doFilter 中对用户的请求进行预处理，把请求体为&quot;application/json&quot;开头的转换成可重复读取 inputStream 的 request：RepeatedlyRequestWrapper，在拦截器的 preHandle 中去验证是否有重复提交，存在则返回 false 结束请求</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
  <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
  <span class="token class-name">ServletRequest</span> requestWrapper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token keyword">instanceof</span> <span class="token class-name">HttpServletRequest</span>
      <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">startsWithIgnoreCase</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      requestWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedlyRequestWrapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> requestWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>requestWrapper<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">HandlerMethod</span> handlerMethod <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">;</span>
      <span class="token class-name">Method</span> method <span class="token operator">=</span> handlerMethod<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">RepeatSubmit</span> annotation <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">RepeatSubmit</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRepeatSubmit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> annotation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token class-name">AjaxResult</span> ajaxResult <span class="token operator">=</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>annotation<span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">renderString</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>ajaxResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="日志-log"><a href="#日志-log" class="header-anchor">#</a> 日志 Log</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Log</span><span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;通知公告&quot;</span><span class="token punctuation">,</span> businessType <span class="token operator">=</span> <span class="token class-name">BusinessType</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">)</span>
</code></pre></div><p><strong>基于 AOP 实现</strong></p> <blockquote><p>核心思想：在后置返回通知和异常通知中，获取当前用户信息（用户名、操作模块、业务类型、操作类别）和客户端信息（请求方法、请求方式、请求地址、操作地点、返回参数、状态、异常信息）等，以异步的方式在给定一定延迟后（10ms）写入数据库中（单体版）或调用系统的日志服务写入数据库中</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 处理完请求后执行
 *
 * @param joinPoint 切点
 */</span>
<span class="token annotation punctuation">@AfterReturning</span><span class="token punctuation">(</span>pointcut <span class="token operator">=</span> <span class="token string">&quot;@annotation(controllerLog)&quot;</span><span class="token punctuation">,</span> returning <span class="token operator">=</span> <span class="token string">&quot;jsonResult&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfterReturning</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">,</span> <span class="token class-name">Object</span> jsonResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">handleLog</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> controllerLog<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> jsonResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 拦截异常操作
 *
 * @param joinPoint 切点
 * @param e         异常
 */</span>
<span class="token annotation punctuation">@AfterThrowing</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;@annotation(controllerLog)&quot;</span><span class="token punctuation">,</span> throwing <span class="token operator">=</span> <span class="token string">&quot;e&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doAfterThrowing</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">handleLog</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> controllerLog<span class="token punctuation">,</span> e<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">handleLog</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Log</span> controllerLog<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">Object</span> jsonResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>

      <span class="token comment">// 获取当前的用户</span>
      <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// *========数据库日志=========*//</span>
      <span class="token class-name">SysOperLog</span> operLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysOperLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      operLog<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">BusinessStatus</span><span class="token punctuation">.</span>SUCCESS<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 请求的地址</span>
      <span class="token class-name">String</span> ip <span class="token operator">=</span> <span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getIpAddr</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      operLog<span class="token punctuation">.</span><span class="token function">setOperIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
      operLog<span class="token punctuation">.</span><span class="token function">setOperUrl</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>loginUser <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          operLog<span class="token punctuation">.</span><span class="token function">setOperName</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          operLog<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">BusinessStatus</span><span class="token punctuation">.</span>FAIL<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          operLog<span class="token punctuation">.</span><span class="token function">setErrorMsg</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 设置方法名称</span>
      <span class="token class-name">String</span> className <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">String</span> methodName <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      operLog<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span>className <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> methodName <span class="token operator">+</span> <span class="token string">&quot;()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置请求方式</span>
      operLog<span class="token punctuation">.</span><span class="token function">setRequestMethod</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 处理设置注解上的参数</span>
      <span class="token function">getControllerMethodDescription</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> controllerLog<span class="token punctuation">,</span> operLog<span class="token punctuation">,</span> jsonResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 保存数据库（单体版）</span>
      <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordOper</span><span class="token punctuation">(</span>operLog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 保存数据库（微服务版）</span>
      <span class="token comment">// asyncLogService.saveSysLog(operLog);</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录本地异常日志</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;==前置通知异常==&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;异常信息:{}&quot;</span><span class="token punctuation">,</span> exp<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      exp<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="excel-导出-excel、excels"><a href="#excel-导出-excel、excels" class="header-anchor">#</a> Excel 导出 Excel、Excels</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;序号&quot;</span><span class="token punctuation">,</span> cellType <span class="token operator">=</span> <span class="token class-name">ColumnType</span><span class="token punctuation">.</span>NUMERIC<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;角色状态&quot;</span><span class="token punctuation">,</span> readConverterExp <span class="token operator">=</span> <span class="token string">&quot;0=正常,1=停用&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;部门编号&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>IMPORT<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;操作时间&quot;</span><span class="token punctuation">,</span> width <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> dateFormat <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span>

<span class="token annotation punctuation">@Excels</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;部门名称&quot;</span><span class="token punctuation">,</span> targetAttr <span class="token operator">=</span> <span class="token string">&quot;deptName&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>EXPORT<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token annotation punctuation">@Excel</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;部门负责人&quot;</span><span class="token punctuation">,</span> targetAttr <span class="token operator">=</span> <span class="token string">&quot;leader&quot;</span><span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token class-name">Type</span><span class="token punctuation">.</span>EXPORT<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>核心思想：基于 poi-ooxml 库，查看类的每个字段上是否有对应的注解，再解析注解，把字段的内容写到文档中</p></blockquote> <h3 id="权限控制-requirespermissions、requiresroles、requireslogin"><a href="#权限控制-requirespermissions、requiresroles、requireslogin" class="header-anchor">#</a> 权限控制 RequiresPermissions、RequiresRoles、RequiresLogin</h3> <div class="language- extra-class"><pre class="language-text"><code>@RequiresPermissions(&quot;system:logininfor:list&quot;)
</code></pre></div><p>RequiresPermissions、RequiresRoles、RequiresLogin 这 3 个注解专用于微服务版。</p> <p>因微服务版的权限控制是自定义的，单体版是基于 Spring Security 的，所以要保证一套代码支持单体和微服务切换，现阶段是通过在需要添加权限控制的方法上同时添加有@PreAuthorize 和@RequiresPermissions。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;查询系统访问记录列表&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;@ss.hasPermi('system:logininfor:list')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@RequiresPermissions</span><span class="token punctuation">(</span><span class="token string">&quot;system:logininfor:list&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/list&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">TableDataInfo</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">SysLogininfor</span> logininfor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">startPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SysLogininfor</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> logininforService<span class="token punctuation">.</span><span class="token function">selectLogininforList</span><span class="token punctuation">(</span>logininfor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">getDataTable</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="全局控制器前缀-managerrestcontroller、servicesrestcontroller"><a href="#全局控制器前缀-managerrestcontroller、servicesrestcontroller" class="header-anchor">#</a> 全局控制器前缀 ManagerRestController、ServicesRestController</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ServicesRestController</span><span class="token punctuation">(</span><span class="token string">&quot;/auth&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ManagerRestController</span><span class="token punctuation">(</span><span class="token string">&quot;/system/user/profile&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>用于快速给所有的控制器添加相应的前缀。</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># API前缀</span>
<span class="token key atrule">api</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span>
    <span class="token key atrule">services-prefix</span><span class="token punctuation">:</span> xxx/rest/services
    <span class="token key atrule">manager-prefix</span><span class="token punctuation">:</span> xxx/rest/manager
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ControllerPrefixWebConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">WebMvcConfigurer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">ApiPathProperties</span> apiPathProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configurePathMatch</span><span class="token punctuation">(</span><span class="token class-name">PathMatchConfigurer</span> configurer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        configurer
                <span class="token punctuation">.</span><span class="token function">addPathPrefix</span><span class="token punctuation">(</span>apiPathProperties<span class="token punctuation">.</span><span class="token function">getServicesPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">ServicesRestController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addPathPrefix</span><span class="token punctuation">(</span>apiPathProperties<span class="token punctuation">.</span><span class="token function">getManagerPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> c <span class="token operator">-&gt;</span> c<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">ManagerRestController</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="防止-xss-攻击"><a href="#防止-xss-攻击" class="header-anchor">#</a> 防止 XSS 攻击</h3> <h4 id="定义-xss-注解来对需要的基本信息进行校验"><a href="#定义-xss-注解来对需要的基本信息进行校验" class="header-anchor">#</a> 定义 XSS 注解来对需要的基本信息进行校验</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Xss</span><span class="token punctuation">(</span>message <span class="token operator">=</span> <span class="token string">&quot;用户账号不能包含脚本字符&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="更多信息通过过滤器来处理"><a href="#更多信息通过过滤器来处理" class="header-anchor">#</a> 更多信息通过过滤器来处理</h4> <h5 id="单体版-2"><a href="#单体版-2" class="header-anchor">#</a> 单体版</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssFilter</span> <span class="token keyword">implements</span> <span class="token class-name">Filter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">ServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> req <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">;</span>
        <span class="token class-name">HttpServletResponse</span> resp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">)</span> response<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handleExcludeURL</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> resp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">XssHttpServletRequestWrapper</span> xssRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XssHttpServletRequestWrapper</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">)</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>xssRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="微服务版-2"><a href="#微服务版-2" class="header-anchor">#</a> 微服务版</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;security.xss.enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XssFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// GET DELETE 不过滤</span>
        <span class="token class-name">HttpMethod</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> method<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> method<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">&quot;DELETE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 非json类型，不过滤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isJsonRequest</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// excludeUrls 不过滤</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> xss<span class="token punctuation">.</span><span class="token function">getExcludeUrls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ServerHttpRequestDecorator</span> httpRequestDecorator <span class="token operator">=</span> <span class="token function">requestDecorator</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>httpRequestDecorator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="aop-支持自调用"><a href="#aop-支持自调用" class="header-anchor">#</a> AOP 支持自调用</h3> <blockquote><p>核心思路：采用 AOP 底层原理 JDK 动态代理方式，被代理对象可以通过 AopContext.currentProxy()获取到代理对象，通过调用代理对象的方法进而访问被代理对象的方法（不能直接通过 this 调用，这将调用到被代理对象的该方法，可能失去一些代理对象增强的逻辑）</p></blockquote> <h4 id="单体版-3"><a href="#单体版-3" class="header-anchor">#</a> <strong>单体版</strong></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 表示通过aop框架暴露该代理对象,AopContext能够访问</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="微服务版-3"><a href="#微服务版-3" class="header-anchor">#</a> <strong>微服务版</strong></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 表示通过aop框架暴露该代理对象,AopContext能够访问</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableMapConfig</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="配置时区"><a href="#配置时区" class="header-anchor">#</a> 配置时区</h3> <blockquote><p>核心思路：解决 Jackson 日期反序列化时间问题，配置一个 bean 实现整体修改</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 时区配置
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Jackson2ObjectMapperBuilderCustomizer</span> <span class="token function">jacksonObjectMapperCustomization</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> jacksonObjectMapperBuilder <span class="token operator">-&gt;</span> jacksonObjectMapperBuilder<span class="token punctuation">.</span><span class="token function">timeZone</span><span class="token punctuation">(</span><span class="token class-name">TimeZone</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="只读模式"><a href="#只读模式" class="header-anchor">#</a> 只读模式</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 安全配置</span>
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token key atrule">access</span><span class="token punctuation">:</span>
    <span class="token comment"># 只读开关</span>
    <span class="token key atrule">readonlyEnabled</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>SECURITY_ACCESS_READONLYENABLED<span class="token punctuation">:</span><span class="token boolean important">false</span><span class="token punctuation">}</span>
</code></pre></div><blockquote><p>基于@ModelAttribute 在控制器每个方法执行前被执行，检查当前的请求方法只要是增删改，就抛出 ReadonlyModeException，在 GlobalExceptionHandler 中处理</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@ModelAttribute</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span>     <span class="token punctuation">{</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readonlyEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 增删改 请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;DELETE&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&quot;POST&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">||</span> <span class="token string">&quot;PUT&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ReadonlyModeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RestControllerAdvice</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 只读模式异常
     */</span>
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">ReadonlyModeException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">handleDemoModeException</span><span class="token punctuation">(</span><span class="token class-name">ReadonlyModeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;只读模式，不允许操作&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="单体和微服务自由切换"><a href="#单体和微服务自由切换" class="header-anchor">#</a> 单体和微服务自由切换</h3> <p>支持通过切换 profile 为 local 或 cloud 来实现单体和微服务的自由切换，可满足一个项目在不同环境下部署和应用的需求。</p> <p>为了实现这套机制，项目中很多模块都包含 base、local、cloud 三个子模块，通过 maven 的 profile 来定义不同配置下具体的模块。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profiles</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 单体模式 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>local<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activation</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--默认激活配置--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activeByDefault</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activeByDefault</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activation</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapgis.common.security.artifact</span><span class="token punctuation">&gt;</span></span>mapgis-common-local-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapgis.common.security.artifact</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 微服务模式 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>profile</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activation</span><span class="token punctuation">&gt;</span></span>
            <span class="token comment">&lt;!--默认激活配置--&gt;</span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activeByDefault</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activeByDefault</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>activation</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapgis.common.security.artifact</span><span class="token punctuation">&gt;</span></span>mapgis-common-cloud-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mapgis.common.security.artifact</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profile</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>profiles</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>对于一个微服务中的接口需要被其他微服务调用时，会将这些接口抽出来定义到<code>-api</code>的模块中，其中<code>-cloud-api</code>用于微服务间调用，<code>-local-api</code>用于模块间调用。这些接口都会在<code>-biz</code>中进行实现，而且<code>-cloud-api</code>的实现会调用<code>-local-api</code>的实现。</p> <p>下面以 system 模块进行举例说明：</p> <p><code>mapgis-module-system-local-api</code>定义了接口<code>ISysServiceApi</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISysServiceApi</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>mapgis-module-system-cloud-api</code>也定义了接口<code>ISysServiceApi</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>contextId <span class="token operator">=</span> <span class="token string">&quot;remoteSysServiceApi&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">ServiceNameConstants</span><span class="token punctuation">.</span>SYSTEM_SERVICE<span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">RemoteSysServiceApiFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISysServiceApi</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>mapgis-module-system-biz</code>有以上 2 个接口的实现，分别是：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;SysServiceApiImpl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysServiceApiImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ISysServiceApi</span>  <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ManagerRestController</span><span class="token punctuation">(</span><span class="token string">&quot;/system/api&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysServiceApiController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;SysServiceApiImpl&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">ISysServiceApi</span> sysServiceApi<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样在任何其他模块中不管是否跨微服务，只要调用<code>ISysServiceApi</code>的接口，在微服务和单体模式下都能调用成功。</p> <h3 id="多数据库支持"><a href="#多数据库支持" class="header-anchor">#</a> 多数据库支持</h3> <p>MyBatis 可以根据不同的数据库厂商执行不同的语句，可参考<a href="https://blog.csdn.net/qq_28898917/article/details/103634570" target="_blank" rel="noopener noreferrer">Mybatis 多数据库支持<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBatisConfig</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DatabaseIdProvider</span> <span class="token function">getDatabaseIdProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DatabaseIdProvider</span> databaseIdProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VendorDatabaseIdProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;MySQL&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;mysql&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">&quot;SQLite&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sqlite&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        databaseIdProvider<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> databaseIdProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>获取数据库品牌标识的示例代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataBaseProduct</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">getProductName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> driver <span class="token operator">=</span> <span class="token string">&quot;org.sqlite.JDBC&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;jdbc:sqlite::resource:static/dq.db?date_string_format=yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Connection</span> con <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Connection</span><span class="token punctuation">)</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DatabaseMetaData</span> metaData <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DatabaseMetaData</span><span class="token punctuation">)</span> con<span class="token punctuation">.</span><span class="token function">getMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据库的产品名称:&quot;</span> <span class="token operator">+</span> metaData<span class="token punctuation">.</span><span class="token function">getDatabaseProductName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>常见的品牌标识如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;property name=&quot;SQL Server&quot; value=&quot;sqlserver&quot;/&gt;
&lt;property name=&quot;DB2&quot; value=&quot;db2&quot;/&gt;
&lt;property name=&quot;Oracle&quot; value=&quot;oracle&quot; /&gt;
&lt;property name=&quot;MySQL&quot; value=&quot;mysql&quot; /&gt;
&lt;property name=&quot;SQLite&quot; value=&quot;sqlite&quot; /&gt;
&lt;property name=&quot;PostgreSQL&quot; value=&quot;postgre&quot; /&gt;
</code></pre></div><h4 id="属性-databaseid"><a href="#属性-databaseid" class="header-anchor">#</a> 属性 databaseId</h4> <p>Mybatis 支持给每个 statement 添加属性<code>databaseId</code>，可根据 databaseId 的取值来写不同的语句，未指明属性的为通用语句。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cleanJobLog<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    truncate table sys_job_log
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cleanJobLog<span class="token punctuation">&quot;</span></span> <span class="token attr-name">databaseId</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sqlite<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    delete
    from sys_job_log;
    update sqlite_sequence
    SET seq = 0
    where name = 'sys_job_log';
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="内置参数-databaseid"><a href="#内置参数-databaseid" class="header-anchor">#</a> 内置参数_databaseId</h4> <p>表示当前数据库的别名，可参考<a href="https://cloud.tencent.com/developer/article/1687061" target="_blank" rel="noopener noreferrer">Mybatis 动态 sql 之内置参数_parameter 和_databaseId<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>update</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>updateJob<span class="token punctuation">&quot;</span></span> <span class="token attr-name">parameterType</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>SysJob<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    update sys_job
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>set</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jobName != null and jobName != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>job_name = #{jobName},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>jobGroup != null and jobGroup != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>job_group = #{jobGroup},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>invokeTarget != null and invokeTarget != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>invoke_target = #{invokeTarget},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>cronExpression != null and cronExpression != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>cron_expression = #{cronExpression},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>misfirePolicy != null and misfirePolicy != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>misfire_policy = #{misfirePolicy},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>concurrent != null and concurrent != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>concurrent = #{concurrent},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>status !=null<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>status = #{status},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>remark != null and remark != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>remark = #{remark},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>updateBy != null and updateBy != ''<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>update_by = #{updateBy},<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>choose</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>when</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>_databaseId == 'sqlite'<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                update_time = (datetime(CURRENT_TIMESTAMP,'localtime'))
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>when</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>otherwise</span><span class="token punctuation">&gt;</span></span>
                update_time = sysdate()
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>otherwise</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>choose</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>set</span><span class="token punctuation">&gt;</span></span>
    where job_id = #{jobId}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>update</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="flyway-数据库版本管理"><a href="#flyway-数据库版本管理" class="header-anchor">#</a> flyway 数据库版本管理</h3> <p>单体版采用 flyway 来管理数据库版本，支持在部署的时候执行相应的数据库脚本，这里采用手动编写代码的方式进行，可参考<a href="https://blog.csdn.net/qq_35995691/article/details/122770451" target="_blank" rel="noopener noreferrer">SpringBoot 中使用 Flyway<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h4 id="配置-关闭自动配置"><a href="#配置-关闭自动配置" class="header-anchor">#</a> 配置（关闭自动配置)</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">flyway</span><span class="token punctuation">:</span>
    <span class="token comment"># flyway自动配置 true 开启</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><h4 id="通过-java-代码进行迁移"><a href="#通过-java-代码进行迁移" class="header-anchor">#</a> 通过 java 代码进行迁移</h4> <p>因需要支持 mysql 和 sqlite，所以在<code>data/migration</code>目录下分别有 2 个数据库的迁移脚本。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${DB_TYPE:sqlite}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> dbType<span class="token punctuation">;</span>

	<span class="token annotation punctuation">@Primary</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token class-name">DynamicDataSourceProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
            org<span class="token punctuation">.</span>flywaydb<span class="token punctuation">.</span>core<span class="token punctuation">.</span>api<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span><span class="token class-name">Configuration</span> configuration <span class="token operator">=</span> <span class="token class-name">Flyway</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dataSource</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baselineDescription</span><span class="token punctuation">(</span><span class="token string">&quot;initByServer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">baselineOnMigrate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">validateOnMigrate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">locations</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:data/migration/%s&quot;</span><span class="token punctuation">,</span> dbType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Flyway</span> flyway <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flyway</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flyway<span class="token punctuation">.</span><span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;数据库迁移出现异常&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="缓存管理"><a href="#缓存管理" class="header-anchor">#</a> 缓存管理</h3> <p>项目中存在用户信息、字典数据等需要缓存的内容，为使单体版更加轻量化，采用了 ehcache 来实现，微服务版采用的是 redis（需要单独启动 redis 服务）。</p> <h4 id="ehcache-与-redis-在实现上存在差异"><a href="#ehcache-与-redis-在实现上存在差异" class="header-anchor">#</a> ehcache 与 redis 在实现上存在差异</h4> <p>获取对象列表时，redis 原生支持模糊匹配，ehcache 不支持，现有实现只支持完全匹配和带有*后缀的模糊匹配</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EhcacheCacheServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CacheService</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
     * 获得缓存的基本对象列表
     *
     * @param pattern 字符串前缀
     * @return 对象列表
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keys <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">String</span> query <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> pattern<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pattern<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">:</span> pattern<span class="token punctuation">;</span>

        <span class="token keyword">return</span> keys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">filter</span><span class="token punctuation">(</span>k <span class="token operator">-&gt;</span> k<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>
                <span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisCacheServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CacheService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获得缓存的基本对象列表
     *
     * @param pattern 字符串前缀
     * @return 对象列表
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>pattern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="验证码开启和关闭"><a href="#验证码开启和关闭" class="header-anchor">#</a> 验证码开启和关闭</h3> <p>目前后端支持开启和关闭，单体版在<code>mapgis-server</code>模块的配置文件<code>application.yml</code>中：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 安全配置</span>
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token comment"># 验证码</span>
  <span class="token key atrule">captcha</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 验证码类型 math 数组计算 char 字符验证</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> math
</code></pre></div><p>微服务版在网关模块的配置文件<code>mapgis-xxx-gateway-server-xxx.yml</code>中（位于 nacos）:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 安全配置</span>
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token comment"># 验证码</span>
  <span class="token key atrule">captcha</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment"># 验证码类型 math 数组计算 char 字符验证</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> math
</code></pre></div><p>前端目前验证码是否开启是固定的，因为后端没有提供获取是否验证码开启和关闭的接口。</p> <h3 id="多终端登录开启和关闭"><a href="#多终端登录开启和关闭" class="header-anchor">#</a> 多终端登录开启和关闭</h3> <p>系统采用token标识用户身份，默认用户允许在多终端同时登录，提供配置<code>token.soloLogin</code>用来限制多终端同时登录</p> <blockquote><p>核心思路：将userid和token（一个用户对应一个token，userid唯一）关联起来存储在缓存中，登录时判断用户是否在别的终端在线，存在就清除缓存信息</p></blockquote> <h4 id="配置-2"><a href="#配置-2" class="header-anchor">#</a> 配置</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># token配置</span>
<span class="token key atrule">token</span><span class="token punctuation">:</span>
  <span class="token comment"># 是否允许账户多终端同时登录（true允许 false不允许）</span>
  <span class="token key atrule">soloLogin</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>SOLO_LOGIN_ENABLED<span class="token punctuation">:</span><span class="token boolean important">true</span><span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 根据用户Id踢出登录用户，用于不允许多终端登录时，清除用户Id关联的用户信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">kickoutLoginUser</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>soloLogin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果用户不允许多终端同时登录，清除缓存信息</span>
            <span class="token class-name">String</span> userIdKey <span class="token operator">=</span> <span class="token function">getUserIdKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> userKey <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span>userIdKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cacheService<span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>userIdKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cacheService<span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="配置密码最大错误次数-锁定时间"><a href="#配置密码最大错误次数-锁定时间" class="header-anchor">#</a> 配置密码最大错误次数/锁定时间</h3> <p>通过控制用户登录最大错误次数来锁定用户，可以在需要的时候防止暴力破解</p> <blockquote><p>核心思路：将密码错误登录次数记录到日志和缓存中，每次验证登录信息时判断错误次数是否达到最大次数，达到即提示已经用户已锁定，要解除锁定时，从缓存中清除即可。</p></blockquote> <h4 id="配置-3"><a href="#配置-3" class="header-anchor">#</a> 配置</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 安全配置</span>
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token comment"># 用户配置</span>
  <span class="token key atrule">user</span><span class="token punctuation">:</span>
    <span class="token comment"># 密码</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span>
      <span class="token comment"># 是否开启锁定</span>
      <span class="token key atrule">lock-enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token comment"># 最大错误次数</span>
      <span class="token key atrule">max-retry-count</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token comment"># 锁定时间（默认10分钟）</span>
      <span class="token key atrule">lock-time</span><span class="token punctuation">:</span> <span class="token number">10</span>
</code></pre></div><p>下面用于登录时验证</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysPasswordService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">CacheService</span> cacheService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${security.user.password.lock-enabled:false}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> lockEnabled<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${security.user.password.max-retry-count:5}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxRetryCount<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;${security.user.password.lock-time:10}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> lockTime<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 登录账号密码错误次数缓存键名
     *
     * @param username 用户名
     * @return 缓存键key
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">CacheConstants</span><span class="token punctuation">.</span>PWD_ERR_CNT_KEY <span class="token operator">+</span> username<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">validate</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lockEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Authentication</span> usernamePasswordAuthenticationToken <span class="token operator">=</span> <span class="token class-name">AuthenticationContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>usernamePasswordAuthenticationToken <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> username <span class="token operator">=</span> usernamePasswordAuthenticationToken<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> password <span class="token operator">=</span> usernamePasswordAuthenticationToken<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Integer</span> retryCount <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token function">getCacheKey</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retryCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">&gt;=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>maxRetryCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserPasswordRetryLimitExceedException</span><span class="token punctuation">(</span>maxRetryCount<span class="token punctuation">,</span> lockTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">matches</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retryCount <span class="token operator">=</span> retryCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            cacheService<span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span><span class="token function">getCacheKey</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">,</span> retryCount<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> lockTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserPasswordNotMatchException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">clearLoginRecordCache</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> rawPassword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">matchesPassword</span><span class="token punctuation">(</span>rawPassword<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearLoginRecordCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheService<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token function">getCacheKey</span><span class="token punctuation">(</span>loginName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cacheService<span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span><span class="token function">getCacheKey</span><span class="token punctuation">(</span>loginName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解锁用户</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLogininforController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CacheService</span> cacheService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;账号解锁&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;@ss.hasPermi('system:logininfor:unlock')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@RequiresPermissions</span><span class="token punctuation">(</span><span class="token string">&quot;system:logininfor:unlock&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Log</span><span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;账号解锁&quot;</span><span class="token punctuation">,</span> businessType <span class="token operator">=</span> <span class="token class-name">BusinessType</span><span class="token punctuation">.</span>OTHER<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/unlock/{userName}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;userName&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cacheService<span class="token punctuation">.</span><span class="token function">deleteObject</span><span class="token punctuation">(</span><span class="token class-name">CacheConstants</span><span class="token punctuation">.</span>PWD_ERR_CNT_KEY <span class="token operator">+</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="代码生成"><a href="#代码生成" class="header-anchor">#</a> 代码生成</h3> <p>通过代码生成可以快速生成通用的增删改查的功能，极大地提高我们的开发效率，目前支持基于MySQL数据库中生成兼容MySQL和SQLite的代码</p> <blockquote><p>核心思路：将数据库表的基本信息保存到gen_table表中，而该表的列保存在gen_table_column表中，通过模板引擎velocity生成java、sql等代码</p></blockquote> <h4 id="默认配置"><a href="#默认配置" class="header-anchor">#</a> 默认配置</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 代码生成</span>
<span class="token key atrule">gen</span><span class="token punctuation">:</span>
  <span class="token comment"># 作者</span>
  <span class="token key atrule">author</span><span class="token punctuation">:</span> mapgis
  <span class="token comment"># 默认生成包路径 system 需改成自己的模块名称 如 system monitor tool</span>
  <span class="token key atrule">packageName</span><span class="token punctuation">:</span> com.zondy.mapgis.system
  <span class="token comment"># 自动去除表前缀，默认是false</span>
  <span class="token key atrule">autoRemovePre</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 表前缀（生成类名不会包含表前缀，多个用逗号分隔）</span>
  <span class="token key atrule">tablePrefix</span><span class="token punctuation">:</span> sys_
</code></pre></div><h4 id="支持表结构"><a href="#支持表结构" class="header-anchor">#</a> 支持表结构</h4> <ul><li>单表</li> <li>树表</li> <li>主子表</li></ul> <h4 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h4> <ol><li>准备表</li> <li>进入系统工具-代码生成页面，导入对应表，做相应编辑配置后，生成代码</li> <li>将生成的代码应用到项目
<ul><li>将生成代码中的main目录直接拷贝到后端相应模块的src目录下</li> <li>将生成代码中的vue目录直接拷贝到前端src目录下</li> <li>在数据库下执行sql代码，用于创建菜单和按钮权限</li></ul></li></ol> <h4 id="代码生成器原理"><a href="#代码生成器原理" class="header-anchor">#</a> 代码生成器原理</h4> <h5 id="velocity"><a href="#velocity" class="header-anchor">#</a> Velocity</h5> <p>Velocity是一个基于Java的模板引擎，其提供了一个Context容器，在java代码里面我们可以往容器中存值，然后在vm文件中使用特定的语法获取，这是velocity基本的用法，其与jsp、freemarker并称为三大视图展现技术。作为一个模块引擎，除了作为前后端分离的MVC展现层，Velocity还有一些其他用途，比如源代码生成。</p> <p>在MapGIS Boot系统中，正是使用了Velocity技术实现的源代码生成。大体上，源代码生成只需三步走：</p> <ol><li>创建模板文件</li> <li>准备上下文（变量值）</li> <li>替换模板文件中的变量</li></ol> <p>三步走完之后源代码就生成了，说起来是很简单的，但是实际上做起来会比较麻烦，特别是第一步创建模板文件是最复杂的，以下为index.vue.vm模板文件部分源代码：</p> <div class="language-vue extra-class"><pre class="language-vue"><code>#foreach($column in $columns)
#if($column.insert)
#set($isInsert=1)
#end
#if($column.edit)
#set($isEdit=1)
#end
#if($column.query)
#set($queryCount=$queryCount+1)
#set($dictType=$column.dictType)
#set($AttrName=$column.javaField.substring(0,1).toUpperCase() + ${column.javaField.substring(1)})
#set($parentheseIndex=$column.columnComment.indexOf(&quot;（&quot;))
#if($parentheseIndex != -1)
#set($comment=$column.columnComment.substring(0, $parentheseIndex))
#else
#set($comment=$column.columnComment)
#end
...
</code></pre></div><p>可以看到，该vue模板文件中充斥着大量Velocity的if-else语法，嵌套在一起更是显得无比复杂。</p> <h5 id="information-schema-数据库"><a href="#information-schema-数据库" class="header-anchor">#</a> information_schema 数据库</h5> <p>mysql数据库中有一个information_schema数据库，它是mysql的系统数据库之一，它里面存储着两个表TABLES以及COLUMNS，这两个表分别存储着所有的表信息以及所有表中的列信息，代码生成器正是以两张表的信息为核心实现的。</p> <h5 id="代码生成器源码分析"><a href="#代码生成器源码分析" class="header-anchor">#</a> 代码生成器源码分析</h5> <p>首先看<code>com.zondy.mapgis.gen.controller.GenController#importTableSave</code> 接口，它做了以下这些事情：</p> <ol><li>从information_schema数据库的tables表中查询目标表的表明、标注释、创建时间和更新时间，但是忽略掉定时任务的表和已经生成过的表。</li> <li>初始化表数据并将数据插入数据库的gen_table表</li> <li>从information_schema数据库的columns表中查询目标表的列信息，包含字段名、字段注释、字段类型、是否允许为null等详细信息</li> <li>初始化列信息并将数据插入数据库的gen_table_column表</li></ol> <p>接下来看下 <code>com.zondy.mapgis.gen.controller.GenController#batchGenCode</code> 接口，它做了以下这些事情</p> <ol><li>从数据库的gen_table、gen_table_column表查询出生成代码需要的表和列信息。</li> <li>初始化Velocity</li> <li>准备Velocity上下文信息（变量值信息）</li> <li>读取模板、渲染模板，然后将渲染后的模板内容添加进如压缩流，之后前端就可以下载zip压缩文件了</li></ol> <h2 id="高级功能"><a href="#高级功能" class="header-anchor">#</a> 高级功能</h2> <h3 id="基于oauth2的第三方用户登录"><a href="#基于oauth2的第三方用户登录" class="header-anchor">#</a> 基于OAuth2的第三方用户登录</h3> <p>第三方平台在互联网行业多用户社交</p> <blockquote><p>核心思路：借助JustAuth实现了对第三方平台的OAuth2登录，目前默认集成了对GitHub、Gitee和Gitlab的支持</p></blockquote> <p>通过sys_auth_user的user_id字段建立起与sys_user的联系，当第三方平台初次登录后，会检测本平台内部是否有同名账号，存在同名时，则提示用户直接可以绑定或创建新账号，不存在同名时，直接提示创建新创号，同时，平台已有用户也可以后台设置页面手动进行绑定和解绑。</p> <p>核心流程：</p> <ul><li>已绑定第三方平台用户：请求第三方平台登录-&gt;第三方平台登录回调结果-&gt;响应token到前端-&gt;获取第三方登录用户信息</li> <li>未绑定第三方平台用户：请求第三方平台登录-&gt;第三方平台登录回调结果-&gt;响应绑定前的第三方登录用户信息到前端-&gt;提示绑定或创建新账户-&gt;响应token到前端-&gt;获取绑定后的第三方登录用户信息</li></ul> <p>详见<a href="https://github.com/MapGIS/MapGIS-Boot/blob/master/mapgis-manager/src/views/user/third/thirdLoginMixin.js" target="_blank" rel="noopener noreferrer">thirdLoginMixin.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://github.com/MapGIS/MapGIS-Boot/blob/master/mapgis-boot/mapgis-module-auth/mapgis-module-auth-biz/src/main/java/com/zondy/mapgis/auth/controller/ThirdLoginController.java" target="_blank" rel="noopener noreferrer">ThirdLoginController.java<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>目前后端支持开启和关闭，单体版在<code>mapgis-server</code>模块的配置文件<code>application.yml</code>中：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 第三方登录</span>
<span class="token key atrule">justauth</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span>
    <span class="token key atrule">GITHUB</span><span class="token punctuation">:</span>
      <span class="token key atrule">client-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_GITHUB_CLIENT_ID<span class="token punctuation">}</span>
      <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_GITHUB_CLIENT_SECRET<span class="token punctuation">}</span>
      <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_GITHUB_REDIRECT_URI<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8080/xxx/rest/services/auth/thirdLogin/callback/github<span class="token punctuation">}</span>
    <span class="token key atrule">GITEE</span><span class="token punctuation">:</span>
      <span class="token key atrule">client-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_GITEE_CLIENT_ID<span class="token punctuation">}</span>
      <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_GITEE_CLIENT_SECRET<span class="token punctuation">}</span>
      <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_GITEE_REDIRECT_URI<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8080/xxx/rest/services/auth/thirdLogin/callback/gitee<span class="token punctuation">}</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> default
  <span class="token key atrule">extend</span><span class="token punctuation">:</span>
    <span class="token key atrule">enum-class</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_ENUM_CLASS<span class="token punctuation">:</span>com.zondy.mapgis.auth.justauth.source.AuthCustomSource<span class="token punctuation">}</span>
    <span class="token key atrule">authorize</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_AUTHORIZE_URL<span class="token punctuation">}</span>
    <span class="token key atrule">access-token</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_ACCESS_TOKEN_URL<span class="token punctuation">}</span>
    <span class="token key atrule">user-info</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_USER_INFO_URL<span class="token punctuation">}</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">CUSTOM</span><span class="token punctuation">:</span>
        <span class="token key atrule">request-class</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_REQUEST_CLASS<span class="token punctuation">:</span>com.zondy.mapgis.auth.justauth.request.AuthCustomRequest<span class="token punctuation">}</span>
        <span class="token key atrule">client-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_CLIENT_ID<span class="token punctuation">}</span>
        <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_CLIENT_SECRET<span class="token punctuation">}</span>
        <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_REDIRECT_URI<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8080/xxx/rest/services/auth/thirdLogin/callback/custom<span class="token punctuation">}</span>
        <span class="token key atrule">scopes</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>JUSTAUTH_CUSTOM_SCOPES<span class="token punctuation">}</span>
</code></pre></div><p>微服务版在网关模块的配置文件<code>mapgis-xxx-auth-server-xxx.yml</code>中（位于 nacos）:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># 第三方登录</span>
<span class="token key atrule">justauth</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span>
    <span class="token key atrule">GITHUB</span><span class="token punctuation">:</span>
      <span class="token key atrule">client-id</span><span class="token punctuation">:</span> f770f675866957c53ce6
      <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> 79fdc00cb1fc6b4b4bf9bfc5738b56b14529ca7b
      <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8080/xxx/rest/services/auth/thirdLogin/callback/github
    <span class="token key atrule">GITEE</span><span class="token punctuation">:</span>
      <span class="token key atrule">client-id</span><span class="token punctuation">:</span> a3641bbe80e305d7810d1e848e4e1a9b338066ec16de19792fba1d1a304c8a2f
      <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> f4123a258799dc60284e1e30241ba7276d141aaddea777716f7e675f167d2e4b
      <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8080/xxx/rest/services/auth/thirdLogin/callback/gitee
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> default
  <span class="token key atrule">extend</span><span class="token punctuation">:</span>
    <span class="token key atrule">enum-class</span><span class="token punctuation">:</span> com.zondy.mapgis.auth.justauth.source.AuthCustomSource
    <span class="token key atrule">authorize</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.200.88/oauth/authorize
    <span class="token key atrule">access-token</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.200.88/oauth/token
    <span class="token key atrule">user-info</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//192.168.200.88/api/v4/user
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">CUSTOM</span><span class="token punctuation">:</span>
        <span class="token key atrule">request-class</span><span class="token punctuation">:</span> com.zondy.mapgis.auth.justauth.request.AuthCustomRequest
        <span class="token key atrule">client-id</span><span class="token punctuation">:</span> dcaf95ad5e5cc3d7f5ff8ef06960c3d57a7b18582b5d12b2367388cbf7cd7db5
        <span class="token key atrule">client-secret</span><span class="token punctuation">:</span> 83dc146f7bbca52e14b5eaa6f1963739035c0f625e9cc9c99b43ee846dd90c5b
        <span class="token key atrule">redirect-uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>8080/xxx/rest/services/auth/thirdLogin/callback/custom
        <span class="token key atrule">scopes</span><span class="token punctuation">:</span> read_user openid
</code></pre></div><h3 id="cas单点登录"><a href="#cas单点登录" class="header-anchor">#</a> CAS单点登录</h3> <p>单点登录SSO(Single Sign-On) 是一种统一认证和授权机制，指访问同一服务器不同应用中的受保护资源的同一用户，只需要登录一次，即通过一个应用中的安全验证后，再访问其他应用中的受保护资源时，不再需要重新登录验证。</p> <h4 id="cas单点登录服务端准备"><a href="#cas单点登录服务端准备" class="header-anchor">#</a> CAS单点登录服务端准备</h4> <p>需要搭建单独的服务端应用，可参考官网地址<a href="https://github.com/apereo/cas-overlay-template" target="_blank" rel="noopener noreferrer">https://github.com/apereo/cas-overlay-template<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>一般情况下需要基于JDBC提供对动态用户的支持</p></blockquote> <p>配置application.properties参考：</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># http端口</span>
<span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8888</span>
<span class="token comment"># https</span>
<span class="token attr-name">server.ssl.enabled</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token comment"># 证书路径</span>
<span class="token attr-name">server.ssl.key-store</span><span class="token punctuation">=</span><span class="token attr-value">config/ldkeystore.p12</span>
<span class="token comment"># 别名密码</span>
<span class="token attr-name">server.ssl.key-store-password</span><span class="token punctuation">=</span><span class="token attr-value">123456</span>
<span class="token attr-name">server.ssl.key-password</span><span class="token punctuation">=</span><span class="token attr-value">123456</span>
<span class="token comment"># 证书类型</span>
<span class="token attr-name">server.ssl.key-store-type</span><span class="token punctuation">=</span><span class="token attr-value">PKCS12</span>
<span class="token comment"># 别名</span>
<span class="token attr-name">server.ssl.key-alias</span><span class="token punctuation">=</span><span class="token attr-value">undertow</span>
<span class="token comment"># 设置安全为false</span>
<span class="token attr-name">cas.tgc.secure</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token comment"># 开启识别json文件，默认false</span>
<span class="token attr-name">cas.serviceRegistry.initFromJson</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
<span class="token attr-name">cas.logout.follow-service-redirects</span><span class="token punctuation">=</span><span class="token attr-value">true</span>

<span class="token comment">##</span>
<span class="token comment"># CAS Authentication Credentials</span>
<span class="token comment">#</span>
<span class="token attr-name">cas.authn.jdbc.query[0].url</span><span class="token punctuation">=</span><span class="token attr-value">jdbc:mysql://localhost:3306/mapgis-xxx?useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=true&amp;serverTimezone=GMT%2B8</span>
<span class="token attr-name">cas.authn.jdbc.query[0].user</span><span class="token punctuation">=</span><span class="token attr-value">root</span>
<span class="token attr-name">cas.authn.jdbc.query[0].password</span><span class="token punctuation">=</span><span class="token attr-value">cloud123.mapgis</span>
<span class="token attr-name">cas.authn.jdbc.query[0].sql</span><span class="token punctuation">=</span><span class="token attr-value">select * from sys_user where user_name=?</span>
<span class="token attr-name">cas.authn.jdbc.query[0].fieldPassword</span><span class="token punctuation">=</span><span class="token attr-value">password</span>
<span class="token attr-name">cas.authn.jdbc.query[0].driverClass</span><span class="token punctuation">=</span><span class="token attr-value">com.mysql.cj.jdbc.Driver</span>
<span class="token comment">#开启自定义密码验证</span>
<span class="token attr-name">cas.authn.jdbc.query[0].passwordEncoder.type</span><span class="token punctuation">=</span><span class="token attr-value">com.cas.password.MyPasswordEncoder</span>
<span class="token attr-name">cas.authn.jdbc.query[0].fieldDisabled</span><span class="token punctuation">=</span><span class="token attr-value">status</span>
</code></pre></div><p>启动脚本startup.bat参考：</p> <div class="language-shell extra-class"><pre class="language-shell"><code>@echo off
<span class="token builtin class-name">cd</span> /d %~dp0
<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>
@echo on
java.exe -jar lib/cas.war --cas.standalone.configuration-directory<span class="token operator">=</span>config
pause
</code></pre></div><h4 id="单点登录流程"><a href="#单点登录流程" class="header-anchor">#</a> 单点登录流程</h4> <p>在本平台前后端分离模式下，单点登录中service采用的是后端接口，而非前端，当后端验证通过后，会携带token重定向到前端，前端基于token校验用户信息再跳转到去除token参数的前端页面</p> <blockquote><p>核心思想：基于spring-security-cas，在单体版和微服务版中均提供了对cas的对接支持</p></blockquote> <p>后端关键代码<a href="https://github.com/MapGIS/MapGIS-Boot/blob/master/mapgis-boot/mapgis-module-auth/mapgis-module-auth-biz/src/main/java/com/zondy/mapgis/auth/cas/config/CasSecurityConfig.java" target="_blank" rel="noopener noreferrer">CasSecurityConfig.java<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;cas&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;enabled&quot;</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CasSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// 添加CAS 认证filter</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token function">casAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加JWT filter</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>authenticationTokenFilter<span class="token punctuation">,</span> <span class="token class-name">CasAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token function">casLogoutFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LogoutFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span><span class="token function">singleSignOutFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">CasAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 添加CORS filter</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>corsFilter<span class="token punctuation">,</span> <span class="token class-name">JwtAuthenticationTokenFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>corsFilter<span class="token punctuation">,</span> <span class="token class-name">LogoutFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 身份认证接口
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span>auth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        auth<span class="token punctuation">.</span><span class="token function">authenticationProvider</span><span class="token punctuation">(</span><span class="token function">casAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 指定service相关信息
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServiceProperties</span> <span class="token function">serviceProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceProperties</span> serviceProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置cas客户端登录完整的url</span>
        serviceProperties<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>casProperties<span class="token punctuation">.</span><span class="token function">getCasServiceUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> casProperties<span class="token punctuation">.</span><span class="token function">getCasServiceLoginUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        serviceProperties<span class="token punctuation">.</span><span class="token function">setAuthenticateAllArtifacts</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> serviceProperties<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * CAS认证过滤器
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CasAuthenticationFilter</span> <span class="token function">casAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">CasAuthenticationFilter</span> casAuthenticationFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setFilterProcessesUrl</span><span class="token punctuation">(</span>casProperties<span class="token punctuation">.</span><span class="token function">getCasServiceLoginUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span>casAuthenticationSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> casAuthenticationFilter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * CAS认证Provider
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">CasAuthenticationProvider</span> <span class="token function">casAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CasAuthenticationProvider</span> casAuthenticationProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setAuthenticationUserDetailsService</span><span class="token punctuation">(</span>casUserDetailsService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setServiceProperties</span><span class="token punctuation">(</span><span class="token function">serviceProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setTicketValidator</span><span class="token punctuation">(</span><span class="token function">cas20ServiceTicketValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">&quot;casAuthenticationProviderKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> casAuthenticationProvider<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * CAS票证验证器
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Cas20ServiceTicketValidator</span> <span class="token function">cas20ServiceTicketValidator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Cas20ServiceTicketValidator</span><span class="token punctuation">(</span>casProperties<span class="token punctuation">.</span><span class="token function">getCasServerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单点注销过滤器
     * 用于接收cas服务端的注销请求
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SingleSignOutFilter</span> <span class="token function">singleSignOutFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SingleSignOutFilter</span> singleSignOutFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SingleSignOutFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        singleSignOutFilter<span class="token punctuation">.</span><span class="token function">setIgnoreInitConfiguration</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> singleSignOutFilter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单点退出过滤器
     * 用于跳转到cas服务端
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">LogoutFilter</span> <span class="token function">casLogoutFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LogoutFilter</span> logoutFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogoutFilter</span><span class="token punctuation">(</span>casProperties<span class="token punctuation">.</span><span class="token function">getCasServerLogoutUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SecurityContextLogoutHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logoutFilter<span class="token punctuation">.</span><span class="token function">setFilterProcessesUrl</span><span class="token punctuation">(</span>casProperties<span class="token punctuation">.</span><span class="token function">getCasServiceLogoutUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> logoutFilter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletListenerRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SingleSignOutHttpSessionListener</span><span class="token punctuation">&gt;</span></span> <span class="token function">singleSignOutHttpSessionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServletListenerRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SingleSignOutHttpSessionListener</span><span class="token punctuation">&gt;</span></span> servletListenerRegistrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletListenerRegistrationBean</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        servletListenerRegistrationBean<span class="token punctuation">.</span><span class="token function">setListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SingleSignOutHttpSessionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> servletListenerRegistrationBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>前端关键代码<a href="https://github.com/MapGIS/MapGIS-Boot/blob/master/mapgis-manager/src/permission.js" target="_blank" rel="noopener noreferrer">permission.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  NProgress<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// start progress bar</span>
  to<span class="token punctuation">.</span>meta <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>title <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">setDocumentTitle</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">i18nRender</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>domTitle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token comment">/* has token */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">ACCESS_TOKEN</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>allowList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在免登录名单，直接进入</span>
      <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>_CONFIG<span class="token punctuation">[</span><span class="token string">'enableSSO'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> queryParams <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> token <span class="token operator">=</span> queryParams<span class="token punctuation">.</span>token

        <span class="token comment">// 判断来源是不是cas的地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          token <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span>window<span class="token punctuation">.</span>_CONFIG<span class="token punctuation">[</span><span class="token string">'casLoginUrl'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>referrer<span class="token punctuation">)</span> <span class="token operator">||</span>
            document<span class="token punctuation">.</span>referrer<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>host<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">validateToken</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> window<span class="token punctuation">.</span>_CONFIG<span class="token punctuation">[</span><span class="token string">'casLoginUrl'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token operator">:</span> loginRoutePath<span class="token punctuation">,</span> query<span class="token operator">:</span> <span class="token punctuation">{</span> redirect<span class="token operator">:</span> to<span class="token punctuation">.</span>fullPath <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      NProgress<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// if current page is login will not trigger afterEach hook, so manually handle it</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">validateToken</span><span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store
    <span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token string">'ValidateLogin'</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> document<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> url
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> window<span class="token punctuation">.</span>_CONFIG<span class="token punctuation">[</span><span class="token string">'casLoginUrl'</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="前后端配置"><a href="#前后端配置" class="header-anchor">#</a> 前后端配置</h4> <p><strong>前端配置</strong></p> <p><code>public/static/config.js</code></p> <blockquote><p>注意：service后面url，单体版为单体服务的主机端口，微服务版为授权服务的主机端口</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 存放配置常量
 */</span>
window<span class="token punctuation">.</span>_CONFIG <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 单点登录地址</span>
  <span class="token constant">VUE_APP_CAS_LOGIN_URL</span><span class="token operator">:</span> <span class="token string">'http://localhost:8888/cas/login?service=http://localhost:8080/login/cas'</span><span class="token punctuation">,</span>
  <span class="token comment">// 单点登出地址</span>
  <span class="token constant">VUE_APP_CAS_LOGOUT_URL</span><span class="token operator">:</span> <span class="token string">'http://localhost:8888/cas/logout?service=http://localhost:8080/login/cas'</span><span class="token punctuation">,</span>
  <span class="token comment">// 开启单点登录</span>
  <span class="token constant">VUE_APP_SSO</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>后端配置</strong></p> <p>单体版在<code>mapgis-server</code>模块的配置文件<code>application.yml</code>中：</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># cas配置</span>
<span class="token key atrule">cas</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>CAS_ENABLED<span class="token punctuation">:</span><span class="token boolean important">false</span><span class="token punctuation">}</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span>
      <span class="token comment"># cas服务端地址</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>CAS_SERVER_HOST_URL<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8888/cas<span class="token punctuation">}</span>
      <span class="token comment">#cas服务端登录地址</span>
      <span class="token key atrule">login_url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>cas.server.host.url<span class="token punctuation">}</span>/login
      <span class="token comment">#cas服务端登出地址 service参数后面跟就是需要跳转的页面/接口 这里指定的是cas客户端登录接口</span>
      <span class="token key atrule">logout_url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>cas.server.host.url<span class="token punctuation">}</span>/logout<span class="token punctuation">?</span>service=$<span class="token punctuation">{</span>cas.service.host.url<span class="token punctuation">}</span>$<span class="token punctuation">{</span>cas.service.host.login_url<span class="token punctuation">}</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span>
      <span class="token comment"># cas客户端地址</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>CAS_SERVICE_HOST_URL<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span><span class="token punctuation">}</span>
      <span class="token comment"># cas客户端地址登录地址</span>
      <span class="token key atrule">login_url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>CAS_SERVICE_LOGIN_URL<span class="token punctuation">:</span>/login/cas<span class="token punctuation">}</span>
      <span class="token comment"># cas客户端地址登出地址</span>
      <span class="token key atrule">logout_url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>CAS_SERVICE_LOGOUT_URL<span class="token punctuation">:</span>/logout/cas<span class="token punctuation">}</span>
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>CAS_SERVICE_WEB_RUL<span class="token punctuation">:</span>http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token punctuation">}</span>
</code></pre></div><p>微服务版在网关模块的配置文件<code>mapgis-xxx-auth-server-xxx.yml</code>中（位于 nacos）:</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># cas配置</span>
<span class="token key atrule">cas</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span>
      <span class="token comment"># cas服务端地址</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8888/cas
      <span class="token comment">#cas服务端登录地址</span>
      <span class="token key atrule">login_url</span><span class="token punctuation">:</span> /login
      <span class="token comment">#cas服务端登出地址 service参数后面跟就是需要跳转的页面/接口 这里指定的是cas客户端登录接口</span>
      <span class="token key atrule">logout_url</span><span class="token punctuation">:</span> /logout<span class="token punctuation">?</span>service=$<span class="token punctuation">{</span>cas.service.host.url<span class="token punctuation">}</span>$<span class="token punctuation">{</span>cas.service.host.login_url<span class="token punctuation">}</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span>
      <span class="token comment"># cas客户端地址</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
      <span class="token comment"># cas客户端地址登录地址</span>
      <span class="token key atrule">login_url</span><span class="token punctuation">:</span> /login/cas
      <span class="token comment"># cas客户端地址登出地址</span>
      <span class="token key atrule">logout_url</span><span class="token punctuation">:</span> /logout/cas
    <span class="token key atrule">web</span><span class="token punctuation">:</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8000</span>
</code></pre></div><h3 id="微应用路由管理"><a href="#微应用路由管理" class="header-anchor">#</a> 微应用路由管理</h3> <h4 id="什么是微前端"><a href="#什么是微前端" class="header-anchor">#</a> 什么是微前端</h4> <p>微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略。</p> <p>微前端架构旨在解决单体应用在一个相对长的时间跨度下，由于参与的人员、团队的增多、变迁，从一个普通应用演变成一个巨石应用(Frontend Monolith)后，随之而来的应用不可维护的问题。这类问题在企业级 Web 应用中尤其常见。</p> <h4 id="qiankun"><a href="#qiankun" class="header-anchor">#</a> qiankun</h4> <p>qiankun 是蚂蚁金服开源的一款框架，它是基于 single-spa 的。他在 single-spa 的基础上，实现了开箱即用，除一些必要的修改外，子项目只需要做很少的改动，就能很容易的接入。如果说 single-spa 是自行车的话，qiankun 就是个汽车。</p> <h5 id="为什么不是-iframe"><a href="#为什么不是-iframe" class="header-anchor">#</a> 为什么不是 iframe</h5> <p>看这里 <a href="https://www.yuque.com/kuitos/gky7yw/gesexv" target="_blank" rel="noopener noreferrer">Why Not Iframe<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="微应用改造"><a href="#微应用改造" class="header-anchor">#</a> 微应用改造</h4> <p>微前端分为主应用和微应用，MapGIS Boot默认已经集成了qiankun，并传递了相关数据给微应用，更多配置请参考<a href="/mapgis-boot-docs/zh/guide/document/frontend.html#微前端配置">微前端配置</a></p> <p>微应用改造请参考<a href="https://qiankun.umijs.org/zh/guide/tutorial#%E5%BE%AE%E5%BA%94%E7%94%A8" target="_blank" rel="noopener noreferrer">微应用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>默认主应用路由base为<code>/xxx/manager/</code>，在微应用内部设置路由base的时候，需要添加该前缀，比如下面的完整base是<code>/xxx/manager/app-vue</code>，那么注册微应用时activeRule就为<code>/xxx/manager/app-vue</code></p></div> <div class="language-js extra-class"><pre class="language-js"><code>router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  base<span class="token operator">:</span> window<span class="token punctuation">.</span>__POWERED_BY_QIANKUN__ <span class="token operator">?</span> <span class="token string">'/xxx/manager/app-vue/'</span> <span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> <span class="token string">'history'</span><span class="token punctuation">,</span>
  routes<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="微应用注册"><a href="#微应用注册" class="header-anchor">#</a> 微应用注册</h4> <p>支持前端微应用路由的动态注册，同<a href="https://qiankun.umijs.org/zh/api#registermicroappsapps-lifecycles" target="_blank" rel="noopener noreferrer">registerMicroApps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的RegistrableApp类型一样，配置微应用名称<code>name</code>、微应用入口<code>entry</code>和微应用路由<code>activeRule</code>即可，默认container为<code>#micro-page</code></p> <h4 id="通过菜单加载微应用"><a href="#通过菜单加载微应用" class="header-anchor">#</a> 通过菜单加载微应用</h4> <p>支持通过菜单绑定微应用路由地址，实现微应用的加载，配置微应用页面菜单时，在组件路径上需要<code>使用微应用组件</code>，可结合菜单目录实现微应用嵌套路由的跳转。</p> <br> <img src="/mapgis-boot-docs/images/menu-micro-app-create.png" alt="使用微应用组件"> <p>一个包含Vue微应用和React微应用的菜单配置如下：</p> <br> <img src="/mapgis-boot-docs/images/menu-micro-app-show.png" alt="使用微应用组件"> <h2 id="单体版核心功能"><a href="#单体版核心功能" class="header-anchor">#</a> 单体版核心功能</h2> <h3 id="安全配置"><a href="#安全配置" class="header-anchor">#</a> 安全配置</h3> <p>允许登录<code>/xxx/rest/services/auth/login</code>、注册<code>/xxx/rest/services/auth/register</code>、验证码<code>/xxx/rest/services/auth/captchaImage</code>请求路径</p> <p>对于退出<code>/xxx/rest/services/auth/logout</code>请求设置处理类<code>LogoutSuccessHandlerImpl</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    	httpSecurity
        <span class="token comment">// CSRF禁用，因为不使用session</span>
        <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 认证失败处理类</span>
        <span class="token punctuation">.</span><span class="token function">exceptionHandling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticationEntryPoint</span><span class="token punctuation">(</span>unauthorizedHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 基于token，所以不需要session</span>
        <span class="token punctuation">.</span><span class="token function">sessionManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sessionCreationPolicy</span><span class="token punctuation">(</span><span class="token class-name">SessionCreationPolicy</span><span class="token punctuation">.</span>STATELESS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 过滤请求</span>
        <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// 对于登录login 注册register 验证码captchaImage 允许匿名访问</span>
        <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/services/auth/login&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/xxx/rest/services/auth/register&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;/xxx/rest/services/auth/captchaImage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/services/auth/logout&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span>logoutSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="登录流程"><a href="#登录流程" class="header-anchor">#</a> 登录流程</h3> <h4 id="_1、获取验证码-xxx-rest-services-auth-captchaimage"><a href="#_1、获取验证码-xxx-rest-services-auth-captchaimage" class="header-anchor">#</a> 1、获取验证码/xxx/rest/services/auth/captchaImage</h4> <p>直接由 mapgis-xxx-auth-server 中 CaptchaController 控制器/auth/captchaImage 接口对应的方法处理。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;生成验证码&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/captchaImage&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">createCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> validateCodeService<span class="token punctuation">.</span><span class="token function">createCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、authcontroller-控制器方法-login-进行处理"><a href="#_2、authcontroller-控制器方法-login-进行处理" class="header-anchor">#</a> 2、AuthController 控制器方法 login 进行处理</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;登录方法&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">LoginBody</span> loginBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AjaxResult</span> ajax <span class="token operator">=</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 生成令牌</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>loginBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ajax<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TokenConstants</span><span class="token punctuation">.</span>TOKEN<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ajax<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、验证登录信息的有效性"><a href="#_3、验证登录信息的有效性" class="header-anchor">#</a> 3、验证登录信息的有效性</h4> <p>校验验证码、验证用户</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 登录验证
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginBody</span> loginBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> loginBody<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password <span class="token operator">=</span> loginBody<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 校验验证码</span>
        validateCodeService<span class="token punctuation">.</span><span class="token function">checkCaptcha</span><span class="token punctuation">(</span>loginBody<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loginBody<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 用户验证</span>
        <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 该方法会去调用UserDetailsServiceImpl.loadUserByUsername</span>
            authentication <span class="token operator">=</span> authenticationManager
                    <span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_FAIL<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.password.not.match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UserPasswordNotMatchException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_FAIL<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>UserDetailsServiceImpl.loadUserByUsername</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDetailsServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SysUser</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectUserByUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;登录用户：{} 不存在.&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;登录用户：&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot; 不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserStatus</span><span class="token punctuation">.</span>DELETED<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getDelFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;登录用户：{} 已被删除.&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;对不起，您的账号：&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot; 已被删除&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">UserStatus</span><span class="token punctuation">.</span>DISABLE<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;登录用户：{} 已被停用.&quot;</span><span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;对不起，您的账号：&quot;</span> <span class="token operator">+</span> username <span class="token operator">+</span> <span class="token string">&quot; 已停用&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token function">createLoginUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">createLoginUser</span><span class="token punctuation">(</span><span class="token class-name">SysUser</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getDeptId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> permissionService<span class="token punctuation">.</span><span class="token function">getMenuPermission</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回用户信息 LoginUser，除包含 SysUser 外，还包含了角色、权限信息。</p> <h4 id="_4、记录登录日志-更新用户登录信息"><a href="#_4、记录登录日志-更新用户登录信息" class="header-anchor">#</a> 4、记录登录日志，更新用户登录信息</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 登录验证
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">LoginBody</span> loginBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">// ...</span>
    	<span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_SUCCESS<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.login.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LoginUser</span><span class="token punctuation">)</span> authentication<span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">recordLoginInfo</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成token</span>
        <span class="token keyword">return</span> tokenService<span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5、返回登录令牌"><a href="#_5、返回登录令牌" class="header-anchor">#</a> 5、返回登录令牌</h4> <p>设置用户登录的更多信息，缓存用户登录信息（<code>login_tokens:</code>开头），生成 JWT Token</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenService</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
     * 创建令牌
     *
     * @param loginUser 用户信息
     * @return 令牌
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">IdUtils</span><span class="token punctuation">.</span><span class="token function">fastUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setUserAgent</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">refreshToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Jwt存储信息</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claimsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        claimsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>USER_KEY<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 生成token</span>
        <span class="token keyword">return</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>claimsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="登出流程"><a href="#登出流程" class="header-anchor">#</a> 登出流程</h3> <h4 id="_1、携带-token-访问服务-xxx-rest-services-auth-logout"><a href="#_1、携带-token-访问服务-xxx-rest-services-auth-logout" class="header-anchor">#</a> 1、携带 Token 访问服务/xxx/rest/services/auth/logout</h4> <h4 id="_2、logoutsuccesshandlerimpl的onlogoutsuccess"><a href="#_2、logoutsuccesshandlerimpl的onlogoutsuccess" class="header-anchor">#</a> 2、<code>LogoutSuccessHandlerImpl</code>的<code>onLogoutSuccess</code></h4> <h4 id="_3、删除用户缓存记录"><a href="#_3、删除用户缓存记录" class="header-anchor">#</a> 3、删除用户缓存记录</h4> <blockquote><p>TokenService-&gt;delLoginUser-&gt;CacheService.deleteObject</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code>tokenService<span class="token punctuation">.</span><span class="token function">delLoginUser</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_4、记录登出日志"><a href="#_4、记录登出日志" class="header-anchor">#</a> 4、记录登出日志</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 记录用户退出日志</span>
<span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>userName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGOUT<span class="token punctuation">,</span> <span class="token string">&quot;退出成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="注册流程"><a href="#注册流程" class="header-anchor">#</a> 注册流程</h3> <h4 id="_1、带上请求体-registerbody-访问-xxx-rest-services-auth-register"><a href="#_1、带上请求体-registerbody-访问-xxx-rest-services-auth-register" class="header-anchor">#</a> 1、带上请求体 RegisterBody 访问/xxx/rest/services/auth/register</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterBody</span> <span class="token keyword">extends</span> <span class="token class-name">LoginBody</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、authcontroller-控制器方法-register-进行处理"><a href="#_2、authcontroller-控制器方法-register-进行处理" class="header-anchor">#</a> 2、AuthController 控制器方法 register 进行处理</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;用户注册&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/register&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">RegisterBody</span> registerBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 用户注册</span>
	loginService<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>registerBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、验证注册信息的有效性-进行注册"><a href="#_3、验证注册信息的有效性-进行注册" class="header-anchor">#</a> 3、验证注册信息的有效性，进行注册</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterBody</span> registerBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> username <span class="token operator">=</span> registerBody<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password <span class="token operator">=</span> registerBody<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 校验验证码</span>
    validateCodeService<span class="token punctuation">.</span><span class="token function">checkCaptcha</span><span class="token punctuation">(</span>registerBody<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registerBody<span class="token punctuation">.</span><span class="token function">getUuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 注册用户信息</span>
    <span class="token class-name">SysUser</span> sysUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sysUser<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sysUser<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sysUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">encryptPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> registerResult <span class="token operator">=</span> sysServiceApi<span class="token punctuation">.</span><span class="token function">registerUserInfo</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>INNER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>FAIL <span class="token operator">==</span> registerResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>registerResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4、记录注册登录日志"><a href="#_4、记录注册登录日志" class="header-anchor">#</a> 4、记录注册登录日志</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterBody</span> registerBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
	<span class="token class-name">AsyncManager</span><span class="token punctuation">.</span><span class="token function">me</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">AsyncFactory</span><span class="token punctuation">.</span><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTER<span class="token punctuation">,</span>
                <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.register.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="服务访问流程"><a href="#服务访问流程" class="header-anchor">#</a> 服务访问流程</h3> <h4 id="_1、携带令牌-token-访问服务"><a href="#_1、携带令牌-token-访问服务" class="header-anchor">#</a> 1、携带令牌 Token 访问服务</h4> <h4 id="_2、进入到-token-过滤器"><a href="#_2、进入到-token-过滤器" class="header-anchor">#</a> 2、进入到 Token 过滤器</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
     * token认证过滤器
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> authenticationTokenFilter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    	<span class="token comment">// ...</span>
    	<span class="token comment">// 添加JWT filter</span>
        httpSecurity<span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>authenticationTokenFilter<span class="token punctuation">,</span> <span class="token class-name">UsernamePasswordAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、token-过滤器中通过-token-从缓存中获取用户"><a href="#_3、token-过滤器中通过-token-从缓存中获取用户" class="header-anchor">#</a> 3、Token 过滤器中通过 Token 从缓存中获取用户</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">LoginUser</span> <span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取请求携带的令牌</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">getLoginUser</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取用户身份信息
     *
     * @return 用户信息
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">LoginUser</span> <span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token class-name">String</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LoginUser</span> user <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> userkey <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
                user <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">getCacheObject</span><span class="token punctuation">(</span><span class="token function">getTokenKey</span><span class="token punctuation">(</span>userkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> user<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUtils</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
     * 根据request获取请求token
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从header获取token标识</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">TokenConstants</span><span class="token punctuation">.</span>AUTHENTICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">replaceTokenPrefix</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4、将登录用户记录到安全上下文中-便于本线程后面获取"><a href="#_4、将登录用户记录到安全上下文中-便于本线程后面获取" class="header-anchor">#</a> 4、将登录用户记录到安全上下文中，便于本线程后面获取</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtAuthenticationTokenFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">TokenService</span> tokenService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">FilterChain</span> chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> tokenService<span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            tokenService<span class="token punctuation">.</span><span class="token function">verifyToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">UsernamePasswordAuthenticationToken</span> authenticationToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> loginUser<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            authenticationToken<span class="token punctuation">.</span><span class="token function">setDetails</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WebAuthenticationDetailsSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildDetails</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAuthentication</span><span class="token punctuation">(</span>authenticationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUtils</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获取Authentication
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Authentication</span> <span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5、进入到各控制器相应的方法中处理"><a href="#_5、进入到各控制器相应的方法中处理" class="header-anchor">#</a> 5、进入到各控制器相应的方法中处理</h4> <p>有需要可以通过 SecurityUtils 获取用户 ID、用户名称、用户 Key、登录用户信息等。</p> <h2 id="微服务版核心功能"><a href="#微服务版核心功能" class="header-anchor">#</a> 微服务版核心功能</h2> <h3 id="nacos-持久化"><a href="#nacos-持久化" class="header-anchor">#</a> Nacos 持久化</h3> <p>nacos 自身提供了 mysql 的脚本，位于 conf 目录下，创建数据库，导入 sql 脚本后，需要修改 conf/application.properties 配置文件，添加 mysql 的数据源信息。</p> <div class="language- extra-class"><pre class="language-text"><code># db mysql
spring.datasource.platform=mysql
db.num=1
db.url.0=jdbc:mysql://localhost:3306/mapgis-server-config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC
db.user=root
db.password=password
</code></pre></div><h3 id="认证"><a href="#认证" class="header-anchor">#</a> 认证</h3> <blockquote><p>核心思路：</p> <ul><li><p>登录：<strong>网关</strong>模块的 RouterFunctionConfiguration 提供/captchaImage 获取验证码和 UUID，前端将认证信息包装成 LoginBody 调用/auth/login 请求，在网关的过滤器 ValidateCodeFilter 中进行验证码的检查，通过后，进到<strong>认证授权</strong>模块的 AuthController 的 login 方法，通过远程调用<code>sysServiceApi.getUserInfo</code>获取用户信息，当用户存在的时候比较密码，匹配就继续调用<code>sysServiceApi.saveLogininfor</code>记录成功登录，同时创建令牌<code>tokenService.createToken(userInfo)</code>返回 LoginUser，失败就记录访问失败。</p> <blockquote><p>用户 token（随机 UUID）、userId、userName 生成 jwt 的 token，返回的是这个 token，会在缓存中记录这个用户 token 跟 LoginUser 的关系并设定过期时间，每次外部访问携带 jwt 的 token 进来后，要获取用户时<code>tokenSerivice.getLoginUser(token)</code>，都会先拿到用户 token，进而去缓存中拿到 LoginUser。</p></blockquote></li> <li><p>登出：通过 jwt 的 token 删除用户缓存记录<code>cacheService.deleteObject(getTokenKey(JwtUtils.getUserKey(token)))</code>，并拿到用户名<code>JwtUtils.getUserName(token)</code>后记录退出登录<code>sysServiceApi.saveLogininfor</code></p></li> <li><p>在线用户：获取特定缓存“login_tokens:”前缀的缓存列表，转换成用户信息，当强退时，直接删除用户 token 对应的缓存即可，继续访问时，虽然访问令牌存在，但是因为对应的用户缓存被清除，所以会直接抛出异常</p></li></ul></blockquote> <h3 id="接口调用"><a href="#接口调用" class="header-anchor">#</a> 接口调用</h3> <blockquote><p>核心思路：</p> <ul><li>网关全局过滤器 AuthFilter 会验证令牌的有效期，通过后会把用户信息设置到请求头上(user_key、user_id、username)，同时移除内部请求参数来源（防止外部伪造）</li> <li>Feign 的请求拦截器会在调用时，传递请求头上的用户信息设置到 requestTemplate 请求头上(authorization、user_id、username)，目前 Fengin 的拦截器只存在与使用了 EnableCustomConfig 的应用</li> <li>拦截器 HeaderInterceptor 会把用户信息从请求头上拿到后设置到线程变量中方便获取，在请求完成后从线程变量中清除，这样实际请求过程中，不依赖 token 就可以便捷地从 SecurityUtils 中获取用户名或用户</li></ul></blockquote> <h3 id="异步执行"><a href="#异步执行" class="header-anchor">#</a> 异步执行</h3> <p>@EnableASync</p> <p>@ASync</p> <h3 id="网关"><a href="#网关" class="header-anchor">#</a> 网关</h3> <ul><li>网关限流，使用的是路由 id</li> <li>限流规则持久化</li></ul> <h3 id="登录流程-2"><a href="#登录流程-2" class="header-anchor">#</a> 登录流程</h3> <h4 id="_1、获取验证码-xxx-rest-services-auth-captchaimage-2"><a href="#_1、获取验证码-xxx-rest-services-auth-captchaimage-2" class="header-anchor">#</a> 1、获取验证码/xxx/rest/services/auth/captchaImage</h4> <p>基于网关的 RouterFunctionConfiguration 提供了<code>/xxx/rest/services/auth/captchaImage</code>的路由功能，可用于获取验证码 validateCodeService.createCapcha()。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RouterFunctionConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ValidateCodeHandler</span> validateCodeHandler<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;rawtypes&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouterFunction</span> <span class="token function">routerFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">RouterFunctions</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>
                <span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/services/auth/captchaImage&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">RequestPredicates</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>TEXT_PLAIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                validateCodeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateCodeHandler</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ValidateCodeService</span> validateCodeService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerRequest</span> serverRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AjaxResult</span> ajax<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ajax <span class="token operator">=</span> validateCodeService<span class="token punctuation">.</span><span class="token function">createCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CaptchaException</span> <span class="token operator">|</span> <span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">ServerResponse</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">BodyInserters</span><span class="token punctuation">.</span><span class="token function">fromValue</span><span class="token punctuation">(</span>ajax<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateCodeServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ValidateCodeService</span> <span class="token punctuation">{</span>
	<span class="token comment">/**
     * 生成验证码
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">createCaptcha</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">CaptchaException</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、网关验证码过滤器-validatecodefilter-拿到-body-中的-code-和-uuid-后进行验证"><a href="#_2、网关验证码过滤器-validatecodefilter-拿到-body-中的-code-和-uuid-后进行验证" class="header-anchor">#</a> 2、网关验证码过滤器 ValidateCodeFilter 拿到 body 中的 code 和 uuid 后进行验证</h4> <p>认证中心路由 id 配置了 2 个过滤器，其中 CacheRequestFilter 实现 body 请求数据流可重复读，ValidateCodeFilter 专门用于验证验证码。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token comment"># 认证中心</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mapgis<span class="token punctuation">-</span>xxx<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//mapgis<span class="token punctuation">-</span>xxx<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/xxx/rest/services/auth/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># 验证码处理</span>
            <span class="token punctuation">-</span> CacheRequestFilter
            <span class="token punctuation">-</span> ValidateCodeFilter
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateCodeFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Object</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 非登录/注册请求或验证码关闭，不处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsAnyIgnoreCase</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> VALIDATE_URL<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>captchaProperties<span class="token punctuation">.</span><span class="token function">getEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> rspStr <span class="token operator">=</span> <span class="token function">resolveBodyFromRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">JSONObject</span> obj <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>rspStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                validateCodeService<span class="token punctuation">.</span><span class="token function">checkCaptcha</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>CODE<span class="token punctuation">)</span><span class="token punctuation">,</span> obj<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>UUID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">webFluxResponseWriter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、网关鉴权全局过滤器-authfilter-验证"><a href="#_3、网关鉴权全局过滤器-authfilter-验证" class="header-anchor">#</a> 3、网关鉴权全局过滤器 AuthFilter 验证</h4> <p>网关全局过滤器 AuthFilter 首先校验请求路径，位于白名单中的全部跳过，正好<code>/xxx/rest/services/auth/login</code>在白名单中。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 安全配置</span>
<span class="token key atrule">security</span><span class="token punctuation">:</span>
  <span class="token comment"># 不校验白名单</span>
  <span class="token key atrule">ignore</span><span class="token punctuation">:</span>
    <span class="token key atrule">whites</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /xxx/rest/services/auth/logout
      <span class="token punctuation">-</span> /xxx/rest/services/auth/login
      <span class="token punctuation">-</span> /xxx/rest/services/auth/register
      <span class="token punctuation">-</span> /<span class="token important">*/v2/api-docs</span>
      <span class="token punctuation">-</span> /csrf
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpRequest</span><span class="token punctuation">.</span><span class="token class-name">Builder</span> mutate <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> url <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 跳过不需要验证的路径</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> ignoreWhite<span class="token punctuation">.</span><span class="token function">getWhites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;令牌不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;令牌已过期或验证不正确！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> userkey <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> islogin <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token function">getTokenKey</span><span class="token punctuation">(</span>userkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>islogin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;登录状态已过期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> userid <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;令牌验证失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置用户信息到请求</span>
        <span class="token function">addHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>USER_KEY<span class="token punctuation">,</span> userkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">,</span> userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 内部请求来源参数清除</span>
        <span class="token function">removeHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>mutate<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="authcontroller-控制器方法-login-进行处理"><a href="#authcontroller-控制器方法-login-进行处理" class="header-anchor">#</a> AuthController 控制器方法 login 进行处理</h4> <p>经由网关进入到了微服务 mapgis-xxx-auth-server 中 AuthController 控制器/auth/login 接口对应的方法后。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token comment"># 认证中心</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> mapgis<span class="token punctuation">-</span>xxx<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//mapgis<span class="token punctuation">-</span>xxx<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>server
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/xxx/rest/services/auth/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment"># 验证码处理</span>
            <span class="token punctuation">-</span> CacheRequestFilter
            <span class="token punctuation">-</span> ValidateCodeFilter
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ServicesRestController</span><span class="token punctuation">(</span><span class="token string">&quot;/auth&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthController</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;登录方法&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">LoginBody</span> loginBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AjaxResult</span> ajax <span class="token operator">=</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 生成令牌</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> loginService<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span>loginBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ajax<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">TokenConstants</span><span class="token punctuation">.</span>TOKEN<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ajax<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5、通过系统模块的用户服务获取登录用户的信息-loginuser"><a href="#_5、通过系统模块的用户服务获取登录用户的信息-loginuser" class="header-anchor">#</a> 5、通过系统模块的用户服务获取登录用户的信息 LoginUser</h4> <p>在认证中心微服务中调用系统模块的用户服务，采用 OpenFeign 来进行调用，系统模块提供了一个对应的系统接口模块，把其他微服务要用到的接口通过 OpenFeign 进行了包装，这样可以像调用本地服务一样来调用远程服务。</p> <p>在微服务模块的入口需要添加@EnableFeignClients，这里有自定义注解@EnableMapFeignClients，在服务消费者的访问接口上需要添加@FeignClient。</p> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 系统服务API，提供其他独立模块调用
 *
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>contextId <span class="token operator">=</span> <span class="token string">&quot;remoteSysServiceApi&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">ServiceNameConstants</span><span class="token punctuation">.</span>SYSTEM_SERVICE<span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">RemoteSysServiceApiFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISysServiceApi</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 通过用户名查询用户信息
     *
     * @param username 用户名
     * @param source   请求来源
     * @return 结果
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/manager/system/api/user/info/{username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 注册用户信息
     *
     * @param sysUser 用户信息
     * @param source  请求来源
     * @return 结果
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/manager/system/api/user/register&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">registerUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SysUser</span> sysUser<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_6、验证登录信息的有效性"><a href="#_6、验证登录信息的有效性" class="header-anchor">#</a> 6、验证登录信息的有效性</h4> <p>从系统模块拿到的登录用户信息 LoginUser，除包含 SysUser 外，还包含了角色、权限信息。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ManagerRestController</span><span class="token punctuation">(</span><span class="token string">&quot;/system/api&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysServiceApiController</span> <span class="token keyword">extends</span> <span class="token class-name">BaseController</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获取当前用户信息
     */</span>
    <span class="token annotation punctuation">@InnerAuth</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/info/{username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sysServiceApi<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span><span class="token string">&quot;SysServiceApiImpl&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysServiceApiImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ISysServiceApi</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SysUser</span> sysUser <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">selectUserByUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&quot;用户名或密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 角色集合</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> permissionService<span class="token punctuation">.</span><span class="token function">getRolePermission</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 权限集合</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> permissionService<span class="token punctuation">.</span><span class="token function">getMenuPermission</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoginUser</span> sysUserVo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserVo<span class="token punctuation">.</span><span class="token function">setUser</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserVo<span class="token punctuation">.</span><span class="token function">setRoles</span><span class="token punctuation">(</span>roles<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUserVo<span class="token punctuation">.</span><span class="token function">setPermissions</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">R</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>sysUserVo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>调用安全模块进行密码匹配验证。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">matchesPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_FAIL<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.password.not.match&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span><span class="token string">&quot;用户不存在/密码错误&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_7、调用系统模块的访问日志服务记录成功和失败的登录操作"><a href="#_7、调用系统模块的访问日志服务记录成功和失败的登录操作" class="header-anchor">#</a> 7、调用系统模块的访问日志服务记录成功和失败的登录操作</h4> <p>访问日志服务是由系统模块微服务提供的，在认证中心模块内调用，需要和获取系统模块的用户信息一样，定义服务接口，采用 OpenFeign 的方式进行调用。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 系统服务API，提供其他独立模块调用
 *
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>contextId <span class="token operator">=</span> <span class="token string">&quot;remoteSysServiceApi&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">ServiceNameConstants</span><span class="token punctuation">.</span>SYSTEM_SERVICE<span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">RemoteSysServiceApiFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISysServiceApi</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 保存系统日志
     *
     * @param sysOperLog 日志实体
     * @param source     请求来源
     * @return 结果
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/manager/system/api/operlog&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveLog</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SysOperLog</span> sysOperLog<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 保存访问记录
     *
     * @param sysLogininfor 访问实体
     * @param source        请求来源
     * @return 结果
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/manager/system/api/logininfor&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">saveLogininfor</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">SysLogininfor</span> sysLogininfor<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 记录登录信息
     *
     * @param username 用户名
     * @param status   状态
     * @param message  消息内容
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordLogininfor</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">String</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SysLogininfor</span> logininfor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysLogininfor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logininfor<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logininfor<span class="token punctuation">.</span><span class="token function">setIpaddr</span><span class="token punctuation">(</span><span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getIpAddr</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logininfor<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 日志状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsAny</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_SUCCESS<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGOUT<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logininfor<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_SUCCESS_STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_FAIL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logininfor<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGIN_FAIL_STATUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sysServiceApi<span class="token punctuation">.</span><span class="token function">saveLogininfor</span><span class="token punctuation">(</span>logininfor<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>INNER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_8、返回登录信息-包括令牌"><a href="#_8、返回登录信息-包括令牌" class="header-anchor">#</a> 8、返回登录信息，包括令牌</h4> <p>基于获取到的 LoginUser，设置用户 key、用户 id、用户名、登录 ip、登录时间、令牌过期时间，并通过用户 key、用户 id 和用户名调用 jjwt 生成令牌，返回给外部。</p> <p>过期原理：依靠的是 redis 的<strong>TTL</strong>（Time To Live，剩余生存时间）失效机制实现。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;code&quot;</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
  <span class="token property">&quot;msg&quot;</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;access_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;expires_in&quot;</span><span class="token operator">:</span> <span class="token number">720</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TokenService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 创建令牌
     *
     * @param loginUser 用户信息
     * @return 令牌
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">createToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">IdUtils</span><span class="token punctuation">.</span><span class="token function">fastUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userName <span class="token operator">=</span> loginUser<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setIpaddr</span><span class="token punctuation">(</span><span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getIpAddr</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">refreshToken</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Jwt存储信息</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> claimsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        claimsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>USER_KEY<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        claimsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        claimsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 生成token</span>
        <span class="token keyword">return</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">createToken</span><span class="token punctuation">(</span>claimsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 刷新令牌有效期
     *
     * @param loginUser 登录信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refreshToken</span><span class="token punctuation">(</span><span class="token class-name">LoginUser</span> loginUser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setLoginTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        loginUser<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getLoginTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> expireTime <span class="token operator">*</span> MILLIS_MINUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据uuid将loginUser缓存</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token function">getTokenKey</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cacheService<span class="token punctuation">.</span><span class="token function">setCacheObject</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span> loginUser<span class="token punctuation">,</span> expireTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="登出流程-2"><a href="#登出流程-2" class="header-anchor">#</a> 登出流程</h3> <h4 id="_1、携带-token-访问服务-xxx-rest-services-auth-logout-2"><a href="#_1、携带-token-访问服务-xxx-rest-services-auth-logout-2" class="header-anchor">#</a> 1、携带 Token 访问服务/xxx/rest/services/auth/logout</h4> <h4 id="_2、网关过滤器跳过-验证码过滤器、全局过滤器"><a href="#_2、网关过滤器跳过-验证码过滤器、全局过滤器" class="header-anchor">#</a> 2、网关过滤器跳过（验证码过滤器、全局过滤器）</h4> <p>位于验证码的忽略名单和全局过滤器的白名单中，直接跳过。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValidateCodeFilter</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Object</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 非登录/注册请求或验证码关闭，不处理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsAnyIgnoreCase</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> VALIDATE_URL<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>captchaProperties<span class="token punctuation">.</span><span class="token function">getEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//...</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、网关路由到-logincontroller-的-logout-映射的方法"><a href="#_3、网关路由到-logincontroller-的-logout-映射的方法" class="header-anchor">#</a> 3、网关路由到 LoginController 的/logout 映射的方法</h4> <h4 id="_4、删除用户缓存记录"><a href="#_4、删除用户缓存记录" class="header-anchor">#</a> 4、删除用户缓存记录</h4> <blockquote><p>AuthUtil.logoutByToken-&gt;AuthLogic.logoutByToken-&gt;TokenService-&gt;delLoginUser-&gt;CacheService.deleteObject</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;用户退出&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span><span class="token punctuation">(</span><span class="token string">&quot;logout&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">AjaxResult</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除用户缓存记录</span>
        <span class="token class-name">AuthUtil</span><span class="token punctuation">.</span><span class="token function">logoutByToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 记录用户退出日志</span>
        loginService<span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token class-name">AjaxResult</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5、记录登出日志"><a href="#_5、记录登出日志" class="header-anchor">#</a> 5、记录登出日志</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span>  <span class="token punctuation">{</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">logout</span><span class="token punctuation">(</span><span class="token class-name">String</span> loginName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>loginName<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>LOGOUT<span class="token punctuation">,</span> <span class="token string">&quot;退出成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="注册流程-2"><a href="#注册流程-2" class="header-anchor">#</a> 注册流程</h3> <h4 id="_1、带上请求体-registerbody-访问-xxx-rest-services-auth-register-2"><a href="#_1、带上请求体-registerbody-访问-xxx-rest-services-auth-register-2" class="header-anchor">#</a> 1、带上请求体 RegisterBody 访问/xxx/rest/services/auth/register</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterBody</span> <span class="token keyword">extends</span> <span class="token class-name">LoginBody</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、网关过滤器跳过-验证码过滤器、全局过滤器-2"><a href="#_2、网关过滤器跳过-验证码过滤器、全局过滤器-2" class="header-anchor">#</a> 2、网关过滤器跳过（验证码过滤器、全局过滤器）</h4> <h4 id="_3、网关路由到-authcontroller-的-register-映射的方法"><a href="#_3、网关路由到-authcontroller-的-register-映射的方法" class="header-anchor">#</a> 3、网关路由到 AuthController 的/register 映射的方法</h4> <h4 id="_4、调用系统模块的用户注册服务"><a href="#_4、调用系统模块的用户注册服务" class="header-anchor">#</a> 4、调用系统模块的用户注册服务</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SysLoginService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 注册
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">RegisterBody</span> registerBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> registerBody<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password <span class="token operator">=</span> registerBody<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 注册用户信息</span>
        <span class="token class-name">SysUser</span> sysUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SysUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUser<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUser<span class="token punctuation">.</span><span class="token function">setNickName</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sysUser<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">encryptPassword</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> registerResult <span class="token operator">=</span> sysServiceApi<span class="token punctuation">.</span><span class="token function">registerUserInfo</span><span class="token punctuation">(</span>sysUser<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>INNER<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">R</span><span class="token punctuation">.</span>FAIL <span class="token operator">==</span> registerResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServiceException</span><span class="token punctuation">(</span>registerResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTER<span class="token punctuation">,</span> <span class="token class-name">MessageUtils</span><span class="token punctuation">.</span><span class="token function">message</span><span class="token punctuation">(</span><span class="token string">&quot;user.register.success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_5、记录注册日志"><a href="#_5、记录注册日志" class="header-anchor">#</a> 5、记录注册日志</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token function">recordLogininfor</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span>REGISTER<span class="token punctuation">,</span> <span class="token string">&quot;注册成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="服务调用流程"><a href="#服务调用流程" class="header-anchor">#</a> 服务调用流程</h3> <h4 id="_1、服务提供者添加自定义注解-enablemapserverfeignclients"><a href="#_1、服务提供者添加自定义注解-enablemapserverfeignclients" class="header-anchor">#</a> 1、服务提供者添加自定义注解@EnableMapServerFeignClients</h4> <p>服务提供者需要@EnableFeignClients 注解，这里有自定义注解@EnableMapServerFeignClients，指定了@FeignClient 所在的包路径。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@EnableFeignClients</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableMapFeignClients</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">basePackages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token string">&quot;com.zondy.mapgis&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">basePackageClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">defaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">clients</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2、服务提供者添加自定义注解-enablemapconfig"><a href="#_2、服务提供者添加自定义注解-enablemapconfig" class="header-anchor">#</a> 2、服务提供者添加自定义注解@EnableMapConfig</h4> <p>配置 Feign 拦截器，实现服务间调用时，请求头信息的修改。</p> <blockquote><p>实现 RequestInterceptor 接口的 apply 方法，feign 在发送请求之前都会调用该接口的 apply 方法。</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token comment">// 表示通过aop框架暴露该代理对象,AopContext能够访问</span>
<span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>exposeProxy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">// 指定要扫描的Mapper类的包的路径</span>
<span class="token annotation punctuation">@MapperScan</span><span class="token punctuation">(</span><span class="token string">&quot;com.zondy.mapgis.**.mapper&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 开启线程异步执行</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token comment">// 自动加载类</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ApplicationConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">FeignAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">EnableMapConfig</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>

<span class="token comment">/**
 * Feign 配置注册
 **/</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignAutoConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RequestInterceptor</span> <span class="token function">requestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FeignRequestInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * feign 请求拦截器
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignRequestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> requestTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpServletRequest</span> httpServletRequest <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> headers <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>httpServletRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 传递用户信息请求头，防止丢失</span>
            <span class="token class-name">String</span> userId <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> userName <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>userName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">String</span> authentication <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>AUTHORIZATION_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>AUTHORIZATION_HEADER<span class="token punctuation">,</span> authentication<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 配置客户端IP</span>
            requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;X-Forwarded-For&quot;</span><span class="token punctuation">,</span> <span class="token class-name">IpUtils</span><span class="token punctuation">.</span><span class="token function">getIpAddr</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、对于内部服务-不能通过网关调用-在服务提供者的控制器方法上添加-innerauth-注解"><a href="#_3、对于内部服务-不能通过网关调用-在服务提供者的控制器方法上添加-innerauth-注解" class="header-anchor">#</a> 3、对于内部服务（不能通过网关调用）在服务提供者的控制器方法上添加@InnerAuth 注解</h4> <p>用于验证内部服务调用的有效性，内部调用时，会在请求头上添加“from-source”为&quot;inner&quot;，假如用户从网关层调用该服务，会在网关的全局过滤器中移除请求头上的“from-source”标识，让其不能访问。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 内部服务调用验证处理
 */</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerAuthAspect</span> <span class="token keyword">implements</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">&quot;@annotation(innerAuth)&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">innerAround</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> point<span class="token punctuation">,</span> <span class="token class-name">InnerAuth</span> innerAuth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> source <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 内部请求验证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>INNER<span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InnerAuthException</span><span class="token punctuation">(</span><span class="token string">&quot;没有内部访问权限，不允许访问&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> userid <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 用户信息验证</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>innerAuth<span class="token punctuation">.</span><span class="token function">isUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InnerAuthException</span><span class="token punctuation">(</span><span class="token string">&quot;没有设置用户信息，不允许访问 &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> point<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 确保在权限认证aop执行前执行
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 网关鉴权
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token comment">//...</span>
    	<span class="token comment">// 内部请求来源参数清除</span>
        <span class="token function">removeHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>mutate<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4、服务消费者定义服务访问接口添加-feignclient"><a href="#_4、服务消费者定义服务访问接口添加-feignclient" class="header-anchor">#</a> 4、服务消费者定义服务访问接口添加@FeignClient</h4> <p>对于只能内部访问的服务，会在定义服务访问接口时添加参数<code>@RequestHeader(SecurityConstants.FROM_SOURCE) String source</code>，对于 Feign 的调用添加容错处理，定义 fallbackFactory。当微服务出错时，进行提示。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 系统服务API，提供其他独立模块调用
 */</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>contextId <span class="token operator">=</span> <span class="token string">&quot;remoteSysServiceApi&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token class-name">ServiceNameConstants</span><span class="token punctuation">.</span>SYSTEM_SERVICE<span class="token punctuation">,</span> fallbackFactory <span class="token operator">=</span> <span class="token class-name">RemoteSysServiceApiFallbackFactory</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISysServiceApi</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 通过用户名查询用户信息
     *
     * @param username 用户名
     * @param source   请求来源
     * @return 结果
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/xxx/rest/manager/system/api/user/info/{username}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">R</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoginUser</span><span class="token punctuation">&gt;</span></span> <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span> <span class="token class-name">String</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="网关访问流程"><a href="#网关访问流程" class="header-anchor">#</a> 网关访问流程</h3> <h4 id="_1、携带令牌-token-访问服务-2"><a href="#_1、携带令牌-token-访问服务-2" class="header-anchor">#</a> 1、携带令牌 Token 访问服务</h4> <h4 id="_2、网关全局过滤器-authfilter-验证"><a href="#_2、网关全局过滤器-authfilter-验证" class="header-anchor">#</a> 2、网关全局过滤器 AuthFilter 验证</h4> <p>验证 Token 的有效性，令牌不能为空、令牌需要符合规范（能通过 jjwt 获取数据声明）、能从 cacheService 中得到用户 key（通过 token 获取）对应的信息（表示用户登录），通过后将用户信息添加到请求头上，这样网关路由后的服务可以从头上获取解析后的用户 key、用户 id 和用户名。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 网关鉴权
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpRequest</span><span class="token punctuation">.</span><span class="token class-name">Builder</span> mutate <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> url <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 跳过不需要验证的路径</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> ignoreWhite<span class="token punctuation">.</span><span class="token function">getWhites</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;令牌不能为空&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Claims</span> claims <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">parseToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>claims <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;令牌已过期或验证不正确！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> userkey <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> islogin <span class="token operator">=</span> cacheService<span class="token punctuation">.</span><span class="token function">hasKey</span><span class="token punctuation">(</span><span class="token function">getTokenKey</span><span class="token punctuation">(</span>userkey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>islogin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;登录状态已过期&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">String</span> userid <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> username <span class="token operator">=</span> <span class="token class-name">JwtUtils</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span>claims<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">unauthorizedResponse</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token string">&quot;令牌验证失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 设置用户信息到请求</span>
        <span class="token function">addHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>USER_KEY<span class="token punctuation">,</span> userkey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">,</span> userid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">,</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 内部请求来源参数清除</span>
        <span class="token function">removeHeader</span><span class="token punctuation">(</span>mutate<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>FROM_SOURCE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">mutate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>mutate<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3、网关路由到相应的微服务中-被-headerinterceptor-拦截"><a href="#_3、网关路由到相应的微服务中-被-headerinterceptor-拦截" class="header-anchor">#</a> 3、网关路由到相应的微服务中，被 HeaderInterceptor 拦截</h4> <p>只要依赖了 mapgis-common-cloud-security 模块，会自动进行 WebMvcConfigurer 配置，添加 HeaderInterceptor 拦截器，HeaderInterceptor 负责从请求头上拿到在网关上添加的用户信息进行保存，并通过 SecurityUtils.getToken 获取到令牌，进而通过 AuthUtil.getLoginUser 获取到 LoginUser，验证 AuthUtil.verifyLoginUserExpire 有效后，会将 LoginUser 也保存到当前的线程变量中，这样微服务本身就可以直接通过 SecurityUtils 获取到用户和用户信息了。</p> <blockquote><p>方便获取，在请求头拦截器上做了此操作，其他地方可以非常简单地获取这些信息。</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 自定义请求头拦截器，将Header数据封装到线程变量中方便获取
 * 注意：此拦截器会同时验证当前用户有效期自动刷新有效期
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeaderInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">AsyncHandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USER_ID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>DETAILS_USERNAME<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setUserKey</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>USER_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">LoginUser</span> loginUser <span class="token operator">=</span> <span class="token class-name">AuthUtil</span><span class="token punctuation">.</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotNull</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">AuthUtil</span><span class="token punctuation">.</span><span class="token function">verifyLoginUserExpire</span><span class="token punctuation">(</span>loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>LOGIN_USER<span class="token punctuation">,</span> loginUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 安全服务工具类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityUtils</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 获取用户ID
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Long</span> <span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取用户名称
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取用户key
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取登录用户信息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">LoginUser</span> <span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">SecurityConstants</span><span class="token punctuation">.</span>LOGIN_USER<span class="token punctuation">,</span> <span class="token class-name">LoginUser</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取请求token
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 根据request获取请求token
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 从header获取token标识</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token class-name">TokenConstants</span><span class="token punctuation">.</span>AUTHENTICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">replaceTokenPrefix</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_4、路由到相应的微服务控制器中"><a href="#_4、路由到相应的微服务控制器中" class="header-anchor">#</a> 4、路由到相应的微服务控制器中</h4> <p>有需要可以通过 SecurityUtils 获取用户 ID、用户名称、用户 Key、登录用户信息等。</p> <h3 id="网关限流流程"><a href="#网关限流流程" class="header-anchor">#</a> 网关限流流程</h3> <h4 id="_1、配置各微服务采用-sentinel-进行限流"><a href="#_1、配置各微服务采用-sentinel-进行限流" class="header-anchor">#</a> 1、配置各微服务采用 sentinel 进行限流</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># feign 配置</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- SpringCloud Alibaba Sentinel --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="_2、网关模块限流-支持根据-route-id-进行规则设置"><a href="#_2、网关模块限流-支持根据-route-id-进行规则设置" class="header-anchor">#</a> 2、网关模块限流（支持根据 Route ID 进行规则设置）</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!-- SpringCloud Alibaba Sentinel Gateway --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-sentinel-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-xml extra-class"><pre class="language-xml"><code>sentinel:
  # 取消控制台懒加载
  eager: true
  transport:
    # 控制台地址
    dashboard: 127.0.0.1:8718
</code></pre></div><h4 id="_3、配置限流规则持久化"><a href="#_3、配置限流规则持久化" class="header-anchor">#</a> 3、配置限流规则持久化</h4> <div class="language-xml extra-class"><pre class="language-xml"><code>spring:
  cloud:
    sentinel:
      # nacos配置持久化
      datasource:
        ds1:
          nacos:
            server-addr: 127.0.0.1:8848
            dataId: sentinel-mapgis-xxx-gateway-server
            data-type: json
            rule-type: flow
</code></pre></div><p>sentinel-mapgis-xxx-gateway-server 是 json 格式。</p> <div class="language- extra-class"><pre class="language-text"><code>[
  {
    &quot;resource&quot;: &quot;mapgis-xxx-auth-server&quot;,
    &quot;count&quot;: 500,
    &quot;grade&quot;: 1,
    &quot;limitApp&quot;: &quot;default&quot;,
    &quot;strategy&quot;: 0,
    &quot;controlBehavior&quot;: 0
  },
	{
    &quot;resource&quot;: &quot;mapgis-xxx-system-server&quot;,
    &quot;count&quot;: 1000,
    &quot;grade&quot;: 1,
    &quot;limitApp&quot;: &quot;default&quot;,
    &quot;strategy&quot;: 0,
    &quot;controlBehavior&quot;: 0
  },
	{
    &quot;resource&quot;: &quot;mapgis-xxx-job-server&quot;,
    &quot;count&quot;: 300,
    &quot;grade&quot;: 1,
    &quot;limitApp&quot;: &quot;default&quot;,
    &quot;strategy&quot;: 0,
    &quot;controlBehavior&quot;: 0
  }
]
</code></pre></div><h4 id="_4、自定义限流异常"><a href="#_4、自定义限流异常" class="header-anchor">#</a> 4、自定义限流异常</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token class-name">Ordered</span><span class="token punctuation">.</span>HIGHEST_PRECEDENCE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">SentinelFallbackHandler</span> <span class="token function">sentinelGatewayExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelFallbackHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelFallbackHandler</span> <span class="token keyword">implements</span> <span class="token class-name">WebExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">writeResponse</span><span class="token punctuation">(</span><span class="token class-name">ServerResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">ServletUtils</span><span class="token punctuation">.</span><span class="token function">webFluxResponseWriter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;请求超过最大数，请稍候再试&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">BlockException</span><span class="token punctuation">.</span><span class="token function">isBlockException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">handleBlockedRequest</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>response <span class="token operator">-&gt;</span> <span class="token function">writeResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> exchange<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleBlockedRequest</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">GatewayCallbackManager</span><span class="token punctuation">.</span><span class="token function">getBlockHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="网关路由管理"><a href="#网关路由管理" class="header-anchor">#</a> 网关路由管理</h3> <p>网关路由支持从数据库中加载，可动态配置微服务路由，用于后端微服务扩展，控制微服务发布和下线。</p> <h4 id="微服务断言信息配置"><a href="#微服务断言信息配置" class="header-anchor">#</a> 微服务断言信息配置</h4> <br> <img src="/mapgis-boot-docs/images/gateway-route-predicate.png" alt="微服务断言信息配置"> <h4 id="微服务过滤器信息配置"><a href="#微服务过滤器信息配置" class="header-anchor">#</a> 微服务过滤器信息配置</h4> <br> <img src="/mapgis-boot-docs/images/gateway-route-filter.png" alt="微服务过滤器信息配置"></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/mapgis/mapgis-boot/edit/master/docs/zh/guide/document/backend.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2022/9/27 17:10:41</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/mapgis-boot-docs/zh/guide/document/frontend.html" class="prev">
        前端手册
      </a></span> <span class="next"><a href="/mapgis-boot-docs/zh/guide/document/packer.html">
        项目打包
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><div class="my-popup" style="display:none;" data-v-3414bdeb><div class="my-popup-container" data-v-3414bdeb><div class="my-popup-exit" data-v-3414bdeb></div> <img src="" alt data-v-3414bdeb></div></div></div></div>
    <script src="/mapgis-boot-docs/assets/js/app.b0e7f9db.js" defer></script><script src="/mapgis-boot-docs/assets/js/2.ac73687b.js" defer></script><script src="/mapgis-boot-docs/assets/js/9.52885868.js" defer></script>
  </body>
</html>
